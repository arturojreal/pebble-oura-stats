<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oura Stats - Pebble Configuration</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 20px;
            max-width: 400px;
            margin: 0 auto;
            background: #f5f5f5;
            line-height: 1.4;
        }
        .container {
            background: white;
            padding: 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            overflow: hidden;
        }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.2s ease;
        }
        
        .tab-button.active {
            color: #007bff;
            background: white;
            border-bottom: 2px solid #007bff;
        }
        
        .tab-button:hover {
            background: #e9ecef;
        }
        
        .tab-button.active:hover {
            background: white;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
            padding: 25px;
        }
        
        .tab-content.active {
            display: block;
        }
        h1 {
            color: #333;
            margin-bottom: 15px;
            font-size: 22px;
        }
        .status {
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: 500;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        .connect-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            margin: 15px 0;
            border: none;
            cursor: pointer;
        }
        .connect-btn:hover {
            background: #0056b3;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .info {
            background: #e7f3ff;
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 14px;
            color: #0c5460;
        }
        .token-info {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
        }
        .debug-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 12px;
            border-left: 4px solid #007bff;
        }
        .section-box {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            margin: 12px 0;
        }
        .section-title {
            font-weight: 600;
            color: #333;
            margin: 0 0 8px 0;
            font-size: 13px;
        }
        .kv {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 6px 10px;
            font-size: 12px;
            margin-top: 10px;
        }
        .kv div:nth-child(odd) { color: #555; }
        .kv div:nth-child(even) {
            word-break: break-word;
        }
        .debug-log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            max-height: 160px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
            margin: 10px 0;
        }
        .test-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            margin: 5px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #218838;
        }
        .warn { color: #b45400; }
        .ok { color: #1f7a1f; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ko-fi Support CTA -->
        <div style="background: linear-gradient(135deg, #29abe0, #00d4aa); color: white; padding: 15px; text-align: center; font-weight: bold; border-radius: 8px 8px 0 0;">
            <div style="font-size: 16px; margin-bottom: 8px;">‚òï Want to support this development?</div>
            <a href="https://ko-fi.com/arturojreal" target="_blank" style="text-decoration: none; color: inherit; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; display: inline-block; font-size: 14px; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                üíù Buy me a coffee!
            </a>
        </div>
        
        <!-- Construction Banner (Modularized - can be easily commented out) -->
        <!-- CONSTRUCTION_BANNER_START -->
        <div style="background: linear-gradient(135deg, #ff6b6b, #ffa726); color: white; padding: 15px; text-align: center; font-weight: bold;">
            <div style="font-size: 18px; margin-bottom: 5px;">üöß Configuration Pages Under Construction</div>
            <div style="font-size: 14px; opacity: 0.9;" id="construction-date">Loading date... - Some features may experience issues, delays, or unexpected behavior</div>
        </div>
        <!-- CONSTRUCTION_BANNER_END -->
        
        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-button active" onclick="switchTab('setup', this)">‚öôÔ∏è Setup</button>
            <button class="tab-button" onclick="switchTab('customization', this)">üé® Customization</button>
        </div>
        
        <!-- Setup Tab -->
        <div id="setup-tab" class="tab-content active">
            <h1>üèÉ‚Äç‚ôÇÔ∏è Oura Stats Setup</h1>
            
            <!-- Debug Toggle (moved to top for better UX) -->
            <div id="debug-toggle-section" style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                <label style="display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; font-size: 14px;">
                    <input type="checkbox" id="show-debug" onchange="toggleDebugVisibility()" style="transform: scale(1.2);">
                    <span>Show debug information</span>
                </label>
            </div>
            
            <div id="status" class="status disconnected">
            Checking connection...
        </div>

        <div id="connect-section">
            <button id="connect-btn" class="connect-btn">
                Connect to Oura Ring
            </button>
            
            <div class="info">
                <strong>How it works:</strong><br>
                Tap "Connect" ‚Üí Login to Oura ‚Üí Return here automatically
            </div>
        </div>

        <div id="connected-section" style="display: none;">
            <div class="info">
                ‚úÖ Token stored. Review diagnostics below, then tap "Send to Pebble" when ready.
            </div>
            
            <div class="token-info" id="token-display"></div>
            
            <button onclick="sendAndClose()" class="connect-btn">Send to Pebble (Close)</button>
            <button onclick="closeWebview()" class="connect-btn btn-secondary">Close (Don‚Äôt Send)</button>
            <button onclick="clearSettings()" class="connect-btn btn-danger">Clear Settings</button>
        </div>

        <div class="debug-section" style="display: none;">
            <h3>üîç Debug Information</h3>

            <div class="section-box">
                <div class="section-title">Developer Status</div>
                <div class="kv" id="dev-kv"></div>
            </div>

            <div class="section-box">
                <div class="section-title">Live Log</div>
                <div class="debug-log" id="debug-log">Debug information will appear here...</div>
                <div>
                    <button onclick="testOuraAPI()" class="test-button">Test Oura API</button>
                    <button onclick="checkStoredData()" class="test-button">Check Stored Data</button>
                    <button onclick="resendToPebble()" class="test-button">Resend to Pebble</button>
                    <button onclick="copyLog()" class="test-button">Copy Log</button>
                    <button onclick="clearDebugLog()" class="test-button">Clear Log</button>
                </div>
                <div id="copy-status" style="font-size:11px;color:#555;margin-top:6px;display:none;">Copied!</div>
            </div>

            <div class="section-box">
                <div class="section-title">Token Details</div>
                <div id="token-details"></div>
            </div>

            <div class="section-box">
                <div class="section-title">API Test Results</div>
                <div style="margin-bottom:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                    <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:#333;">
                        <input type="checkbox" id="use-proxy-toggle" />
                        Use Proxy for Test
                    </label>
                    <span style="font-size:11px;color:#666;">Direct API calls often fail inside the Pebble webview due to CORS/TLS; enable Proxy.</span>
                </div>
                <div id="api-test-results"></div>
            </div>
        </div>
        
        </div> <!-- End Setup Tab -->
        
        <!-- Customization Tab -->
        <div id="customization-tab" class="tab-content">
            
            <h1>üéõÔ∏è Customization</h1>
            
            <!-- Layout Configuration -->
            <div class="section-box" style="margin: 20px 0;">
                <div class="section-title">üìê Layout Configuration</div>
                <p style="font-size: 14px; color: #666; margin: 10px 0;">Choose how many rows of measurements to display on your watchface.<br>1 row shows larger emojis, 2 rows allows more measurements</p>
                
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Number of Rows:</label>
                    <select id="layout-rows" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="1" selected>1 Row (3 measurements, larger emojis)</option>
                        <option value="2">2 Rows (up to 5 measurements, smaller emojis)</option>
                    </select>
                    <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">1 row provides larger, more visible emojis. 2 rows allow more data but with smaller display.</p>
                </div>
            </div>
            
            <!-- Measurement Organization -->
            <div class="section-box" style="margin: 20px 0;">
                <div class="section-title">üìä Measurement Organization</div>
                <p style="font-size: 14px; color: #666; margin: 10px 0;">Choose which measurement appears in each position on your watchface.</p>
                
                <!-- Visual Layout Preview -->
                <div style="display: flex; justify-content: center; align-items: center; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <div style="text-align: center; margin: 0 15px;">
                        <div style="font-size: 12px; color: #999; margin-bottom: 5px;">LEFT</div>
                        <div id="preview-left" style="font-size: 24px; padding: 10px; background: white; border-radius: 4px; min-width: 60px; border: 2px solid #dee2e6;">üéâ</div>
                        <div style="font-size: 10px; color: #666; margin-top: 5px;">RDY</div>
                    </div>
                    
                    <div style="text-align: center; margin: 0 15px;">
                        <div style="font-size: 12px; color: #999; margin-bottom: 5px;">MIDDLE</div>
                        <div id="preview-middle" style="font-size: 24px; padding: 10px; background: white; border-radius: 4px; min-width: 60px; border: 2px solid #dee2e6;">üò¥</div>
                        <div style="font-size: 10px; color: #666; margin-top: 5px;">SLP</div>
                    </div>
                    
                    <div style="text-align: center; margin: 0 15px;">
                        <div style="font-size: 12px; color: #999; margin-bottom: 5px;">RIGHT</div>
                        <div id="preview-right" style="font-size: 24px; padding: 10px; background: white; border-radius: 4px; min-width: 60px; border: 2px solid #dee2e6;">‚ù§Ô∏è</div>
                        <div style="font-size: 10px; color: #666; margin-top: 5px;">HR</div>
                    </div>
                </div>
                
                <!-- Row 1 Position Selectors -->
                <div style="margin: 20px 0;">
                    <h4 style="margin: 10px 0; color: #333;">Row 1 (Top Row)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 5px;">Left Position:</label>
                            <select id="left-position" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="0">üéâ Readiness</option>
                                <option value="1">üò¥ Sleep</option>
                                <option value="2">‚ù§Ô∏è Heart Rate</option>
                                <option value="3">üî• Activity</option>
                                <option value="4">üò∞ Stress</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 5px;">Middle Position:</label>
                            <select id="middle-position" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="0">üéâ Readiness</option>
                                <option value="1" selected>üò¥ Sleep</option>
                                <option value="2">‚ù§Ô∏è Heart Rate</option>
                                <option value="3">üî• Activity</option>
                                <option value="4">üò∞ Stress</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 5px;">Right Position:</label>
                            <select id="right-position" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="0">üéâ Readiness</option>
                                <option value="1">üò¥ Sleep</option>
                                <option value="2" selected>‚ù§Ô∏è Heart Rate</option>
                                <option value="3">üî• Activity</option>
                                <option value="4">üò∞ Stress</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Row 2 Position Selectors (Hidden by default) -->
                <div id="row2-selectors" style="margin: 20px 0; display: none;">
                    <h4 style="margin: 10px 0; color: #333;">Row 2 (Bottom Row)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 5px;">Left Position:</label>
                            <select id="row2-left-position" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="0">üéâ Readiness</option>
                                <option value="1">üò¥ Sleep</option>
                                <option value="2">‚ù§Ô∏è Heart Rate</option>
                                <option value="3" selected>üî• Activity</option>
                                <option value="4">üò∞ Stress</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 5px;">Right Position:</label>
                            <select id="row2-right-position" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="0">üéâ Readiness</option>
                                <option value="1">üò¥ Sleep</option>
                                <option value="2">‚ù§Ô∏è Heart Rate</option>
                                <option value="3">üî• Activity</option>
                                <option value="4" selected>üò∞ Stress</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="section-box" style="margin: 20px 0;">
                    <div class="section-title">‚öôÔ∏è Display Settings</div>
                    <p style="font-size: 14px; color: #666; margin: 10px 0;">Configure how your watchface displays information.</p>
                    
                    <div style="margin: 15px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Data Refresh Frequency:</label>
                        <select id="refresh-frequency" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="15">15 minutes</option>
                            <option value="30" selected>30 minutes</option>
                            <option value="60">1 hour</option>
                            <option value="120">2 hours</option>
                            <option value="240">4 hours</option>
                        </select>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">üìÖ Date Format:</label>
                        <select id="date-format" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="0" selected>MM-DD-YYYY (US Format)</option>
                            <option value="1">DD-MM-YYYY (International Format)</option>
                        </select>
                        <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Choose how the date appears below the time on your watchface</p>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">üé® Theme Mode:</label>
                        <select id="theme-mode" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="0" selected>üåô Dark Mode (Default)</option>
                            <option value="1">‚òÄÔ∏è Light Mode</option>
                            <option value="2">üé® Custom Color</option>
                        </select>
                        <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Choose between dark mode (white text on black) or light mode (black text on white)</p>
                    </div>
                    
                    <!-- Color Picker Section -->
                    <div id="color-picker-section" style="margin: 15px 0; display: none;">
                        <div class="section-title">üé® Custom Color Selection</div>
                        <p style="font-size: 12px; color: #666; margin: 10px 0;">Choose a background color for your watchface. Text color will automatically adjust for readability.</p>
                        
                        <!-- Color Preview -->
                        <div style="margin: 15px 0; text-align: center;">
                            <div id="color-preview" style="display: inline-block; padding: 20px 40px; border-radius: 8px; background: #000000; color: #ffffff; font-weight: bold; border: 2px solid #ddd;">
                                Selected: <span id="color-name">Black</span>
                            </div>
                        </div>
                        
                        <!-- Color Palette Grid -->
                        <div id="color-palette" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(45px, 1fr)); gap: 6px; max-width: 100%; margin: 0 auto; padding: 0 10px;">
                            <!-- Colors will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="show-debug-watchface" checked style="margin-right: 10px;">
                            <span>Show debug messages on watchface</span>
                        </label>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 15px 0;">
                    <button onclick="applyMeasurementLayout()" class="connect-btn" style="width: auto; padding: 10px 20px;">Apply Layout</button>
                </div>
                
                <!-- Future Customization Options -->
                <div style="padding: 20px; background: #f8f9fa; border-radius: 6px; color: #6c757d; margin-top: 20px;">
                    <strong>Coming Soon:</strong>
                    <ul style="text-align: left; margin: 10px 0; padding-left: 20px; font-size: 14px;">
                        <li>Font size options</li>
                        <li>Custom emoji selection</li>
                    </ul>
                </div>
            </div>
        </div>
        
    </div> <!-- End Container -->

    <script>
        // Tab switching functionality
        function switchTab(tabName, el) {
            // Hide all tab contents
            var tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(function(tab) {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            var tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(function(button) {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked tab button
            if (el) { el.classList.add('active'); }
        }
        
        // Toggle debug information visibility
        function toggleDebugVisibility() {
            var debugSection = document.querySelector('.debug-section');
            var showDebug = document.getElementById('show-debug').checked;
            
            if (showDebug) {
                debugSection.style.display = 'block';
            } else {
                debugSection.style.display = 'none';
            }
        }
        
        // Measurement layout customization - using numeric keys to match select values
        var measurementConfig = {
            '0': { emoji: 'üéâ', label: 'RDY', name: 'readiness' },
            '1': { emoji: 'üò¥', label: 'SLP', name: 'sleep' },
            '2': { emoji: '‚ù§Ô∏è', label: 'HR', name: 'heart_rate' },
            '3': { emoji: 'üî•', label: 'ACT', name: 'activity' },
            '4': { emoji: 'üò∞', label: 'STR', name: 'stress' }
        };
        
        // Smart duplicate prevention - automatically adjust conflicting selections
        function preventDuplicates(changedSelectId) {
            var leftSelect = document.getElementById('left-position');
            var middleSelect = document.getElementById('middle-position');
            var rightSelect = document.getElementById('right-position');
            
            var leftValue = leftSelect.value;
            var middleValue = middleSelect.value;
            var rightValue = rightSelect.value;
            
            var allValues = ['0', '1', '2']; // All possible measurement values
            
            console.log('Preventing duplicates after changing', changedSelectId, '- Values: L=' + leftValue + ' M=' + middleValue + ' R=' + rightValue);
            
            // Find duplicates and resolve them intelligently
            if (changedSelectId === 'left-position') {
                // If left conflicts with middle, move middle to available value
                if (leftValue === middleValue) {
                    var availableForMiddle = allValues.find(function(val) {
                        return val !== leftValue && val !== rightValue;
                    });
                    if (availableForMiddle) {
                        middleSelect.value = availableForMiddle;
                        console.log('Auto-moved middle from', middleValue, 'to', availableForMiddle);
                    }
                }
                // If left conflicts with right, move right to available value
                if (leftValue === rightValue) {
                    var availableForRight = allValues.find(function(val) {
                        return val !== leftValue && val !== middleSelect.value;
                    });
                    if (availableForRight) {
                        rightSelect.value = availableForRight;
                        console.log('Auto-moved right from', rightValue, 'to', availableForRight);
                    }
                }
            } else if (changedSelectId === 'middle-position') {
                // If middle conflicts with left, move left to available value
                if (middleValue === leftValue) {
                    var availableForLeft = allValues.find(function(val) {
                        return val !== middleValue && val !== rightValue;
                    });
                    if (availableForLeft) {
                        leftSelect.value = availableForLeft;
                        console.log('Auto-moved left from', leftValue, 'to', availableForLeft);
                    }
                }
                // If middle conflicts with right, move right to available value
                if (middleValue === rightValue) {
                    var availableForRight = allValues.find(function(val) {
                        return val !== middleValue && val !== leftSelect.value;
                    });
                    if (availableForRight) {
                        rightSelect.value = availableForRight;
                        console.log('Auto-moved right from', rightValue, 'to', availableForRight);
                    }
                }
            } else if (changedSelectId === 'right-position') {
                // If right conflicts with left, move left to available value
                if (rightValue === leftValue) {
                    var availableForLeft = allValues.find(function(val) {
                        return val !== rightValue && val !== middleValue;
                    });
                    if (availableForLeft) {
                        leftSelect.value = availableForLeft;
                        console.log('Auto-moved left from', leftValue, 'to', availableForLeft);
                    }
                }
                // If right conflicts with middle, move middle to available value
                if (rightValue === middleValue) {
                    var availableForMiddle = allValues.find(function(val) {
                        return val !== rightValue && val !== leftSelect.value;
                    });
                    if (availableForMiddle) {
                        middleSelect.value = availableForMiddle;
                        console.log('Auto-moved middle from', middleValue, 'to', availableForMiddle);
                    }
                }
            }
        }
        
        function updateMeasurementLayout() {
            var leftValue = document.getElementById('left-position').value;
            var middleValue = document.getElementById('middle-position').value;
            var rightValue = document.getElementById('right-position').value;
            
            console.log('Updating preview - L:', leftValue, 'M:', middleValue, 'R:', rightValue);
            
            // Update visual preview
            if (measurementConfig[leftValue]) {
                document.getElementById('preview-left').textContent = measurementConfig[leftValue].emoji;
                document.querySelector('#preview-left').nextElementSibling.textContent = measurementConfig[leftValue].label;
            }
            
            if (measurementConfig[middleValue]) {
                document.getElementById('preview-middle').textContent = measurementConfig[middleValue].emoji;
                document.querySelector('#preview-middle').nextElementSibling.textContent = measurementConfig[middleValue].label;
            }
            
            if (measurementConfig[rightValue]) {
                document.getElementById('preview-right').textContent = measurementConfig[rightValue].emoji;
                document.querySelector('#preview-right').nextElementSibling.textContent = measurementConfig[rightValue].label;
            }
            
            // Check for duplicates and enable/disable apply button accordingly
            var positions = [leftValue, middleValue, rightValue];
            var hasDuplicates = positions.length !== new Set(positions).size;
            
            // Visual feedback - always show clean state since we prevent duplicates
            var selects = ['left-position', 'middle-position', 'right-position'];
            selects.forEach(function(selectId) {
                var select = document.getElementById(selectId);
                select.style.borderColor = '#ccc';
                select.style.backgroundColor = 'white';
            });
            
            // Update apply button state
            var applyButton = document.querySelector('button[onclick="applyMeasurementLayout()"]');
            if (hasDuplicates) {
                applyButton.disabled = true;
                applyButton.textContent = 'Fix Duplicates First';
                applyButton.style.backgroundColor = '#6c757d';
            } else {
                applyButton.disabled = false;
                applyButton.textContent = 'Apply Layout';
                applyButton.style.backgroundColor = '#007bff';
            }
        }
        
        function applyMeasurementLayout() {
            // Get flexible layout configuration
            var layoutRows = document.getElementById('layout-rows').value;
            var row1Left = document.getElementById('left-position').value;
            var row1Middle = document.getElementById('middle-position').value;
            var row1Right = document.getElementById('right-position').value;
            var row2Left = document.getElementById('row2-left-position').value;
            var row2Right = document.getElementById('row2-right-position').value;
            
            // Check for duplicates in active positions
            var activePositions = [row1Left, row1Middle, row1Right];
            if (layoutRows === '2') {
                activePositions.push(row2Left, row2Right);
            }
            
            if (activePositions.length !== new Set(activePositions).size) {
                alert('Please ensure each measurement appears in only one position.');
                return;
            }
            
            // Store the flexible layout configuration
            var flexibleLayoutConfig = {
                rows: parseInt(layoutRows),
                row1: {
                    left: parseInt(row1Left),
                    middle: parseInt(row1Middle),
                    right: parseInt(row1Right)
                },
                row2: {
                    left: parseInt(row2Left),
                    right: parseInt(row2Right)
                }
            };
            
            // Store in localStorage for persistence
            localStorage.setItem('oura_flexible_layout', JSON.stringify(flexibleLayoutConfig));
            
            // Also store legacy format for backward compatibility
            var legacyLayoutConfig = {
                left: row1Left,
                middle: row1Middle,
                right: row1Right
            };
            localStorage.setItem('oura_measurement_layout', JSON.stringify(legacyLayoutConfig));
            
            // Send layout update to Pebble immediately
            debugLog('üìä Applying flexible layout: ' + JSON.stringify(flexibleLayoutConfig));
            
            // Send layout data to watchface via webview close
            var currentToken = localStorage.getItem('oura_access_token');
            debugLog('üîç Current token status: ' + (currentToken ? 'Found' : 'Not found'));
            
            if (currentToken) {
                debugLog('üîÑ Sending flexible layout update with token...');
                
                // Get date format setting
                var dateFormat = localStorage.getItem('oura_date_format') || '0';
                
                // Get theme mode setting
                var themeMode = localStorage.getItem('oura_theme_mode') || '0';
                
                // Get custom color data if theme mode is custom color
                var customColorData = null;
                if (themeMode === '2') {
                    var savedColor = localStorage.getItem('oura_custom_color');
                    if (savedColor) {
                        try {
                            customColorData = JSON.parse(savedColor);
                        } catch (e) {
                            console.log('Error parsing custom color data:', e);
                        }
                    }
                }
                
                // Include flexible layout configuration, date format, theme mode, and custom color in the settings
                var settings = {
                    oura_access_token: currentToken,
                    // Legacy layout fields for backward compatibility
                    layout_left: parseInt(row1Left),
                    layout_middle: parseInt(row1Middle),
                    layout_right: parseInt(row1Right),
                    // New flexible layout fields
                    layout_rows: parseInt(layoutRows),
                    row1_left: parseInt(row1Left),
                    row1_middle: parseInt(row1Middle),
                    row1_right: parseInt(row1Right),
                    row2_left: parseInt(row2Left),
                    row2_right: parseInt(row2Right),
                    date_format: parseInt(dateFormat),
                    theme_mode: parseInt(themeMode),
                    config_action: 'flexible_layout_update'
                };
                
                // Add custom color data if available
                if (customColorData) {
                    settings.custom_color_index = customColorData.index;
                    settings.custom_color_name = customColorData.name;
                    settings.custom_color_hex = customColorData.hex;
                    settings.custom_color_pebble = customColorData.pebble;
                }
                
                debugLog('üìä Flexible layout: ' + layoutRows + ' rows');
                debugLog('üìä Row 1: L=' + row1Left + ' M=' + row1Middle + ' R=' + row1Right);
                debugLog('üìä Row 2: L=' + row2Left + ' R=' + row2Right);
                
                var settingsJson = JSON.stringify(settings);
                var encodedSettings = encodeURIComponent(settingsJson);
                var returnUrl = 'pebblejs://close#' + encodedSettings;
                
                debugLog('üì§ Settings JSON: ' + settingsJson);
                debugLog('üì§ Encoded settings length: ' + encodedSettings.length);
                debugLog('üì§ Return URL: ' + returnUrl.substring(0, 100) + '...');
                
                // Close the webview with the layout data
                debugLog('üöÄ Closing webview with layout data...');
                window.location = returnUrl;
            } else {
                debugLog('‚ö†Ô∏è No token found - cannot send layout update');
                debugLog('üí° Layout saved to localStorage - will apply on next data refresh');
                alert('Please connect to your Oura Ring first before applying layout changes.');
            }
            
            // Visual feedback
            var button = document.querySelector('button[onclick="applyMeasurementLayout()"]');
            var originalText = button.textContent;
            button.textContent = '‚úÖ Applied!';
            button.style.backgroundColor = '#28a745';
            
            setTimeout(function() {
                button.textContent = originalText;
                button.style.backgroundColor = '#007bff';
            }, 2000);
        }
        
        function loadSavedMeasurementLayout() {
            var saved = localStorage.getItem('oura_measurement_layout');
            if (saved) {
                try {
                    var layout = JSON.parse(saved);
                    console.log('Loading saved layout:', layout);
                    document.getElementById('left-position').value = layout.left;
                    document.getElementById('middle-position').value = layout.middle;
                    document.getElementById('right-position').value = layout.right;
                    updateMeasurementLayout();
                } catch (e) {
                    console.log('Error loading saved layout:', e);
                    // If loading fails, set defaults and update preview
                    setDefaultLayout();
                }
            } else {
                // No saved layout, set defaults
                setDefaultLayout();
            }
        }
        
        function setDefaultLayout() {
            // Default: Readiness(0) - Sleep(1) - Heart Rate(2)
            document.getElementById('left-position').value = '0';
            document.getElementById('middle-position').value = '1';
            document.getElementById('right-position').value = '2';
            updateMeasurementLayout();
            debugLog('üìä Using default measurement layout');
        }
        
        // PURE STATIC CONFIG - NO POPUPS, ONLY REDIRECTS
        var CLIENT_ID = 'TGDTXUBGWULVNKSC';
        var REDIRECT_URI = 'https://peppy-pothos-093b81.netlify.app/pebble-static-config.html';
        var AUTH_URL = 'https://cloud.ouraring.com/oauth/authorize';
        var SCOPES = 'daily heartrate'; // daily_* endpoints + /usercollection/heartrate

        // Generate OAuth URL - client-side-only flow
        function generateAuthUrl() {
            return AUTH_URL + 
                '?response_type=token' +  // CLIENT-SIDE-ONLY
                '&client_id=' + CLIENT_ID +
                '&redirect_uri=' + encodeURIComponent(REDIRECT_URI) +
                '&scope=' + encodeURIComponent(SCOPES);
        }

        // Check for token in URL fragment
        function checkForToken() {
            var hash = window.location.hash;
            if (hash && hash.includes('access_token=')) {
                var params = new URLSearchParams(hash.substring(1));
                var token = params.get('access_token');
                var expiresIn = params.get('expires_in') || 2592000;
                
                if (token) {
                    // Store token
                    localStorage.setItem('oura_access_token', token);
                    localStorage.setItem('oura_token_expires', Date.now() + (expiresIn * 1000));
                    
                    // Clean URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // Show connected state
                    showConnected(token);
                    // Do not auto-close or auto-send. Developer can review and send manually.
                    return true;
                }
            }
            return false;
        }

        // Check stored token
        function checkStoredToken() {
            var token = localStorage.getItem('oura_access_token');
            var expires = localStorage.getItem('oura_token_expires');
            
            if (token && expires && Date.now() < parseInt(expires)) {
                showConnected(token);
                return true;
            }
            return false;
        }

        // Show connected state
        function showConnected(token) {
            document.getElementById('status').className = 'status connected';
            document.getElementById('status').textContent = '‚úÖ Connected to Oura (token stored)';
            document.getElementById('connect-section').style.display = 'none';
            document.getElementById('connected-section').style.display = 'block';
            
            var display = token.substring(0, 8) + '...' + token.substring(token.length - 4);
            document.getElementById('token-display').textContent = 'Token: ' + display;
        }

        // Show disconnected state
        function showDisconnected() {
            document.getElementById('status').className = 'status disconnected';
            document.getElementById('status').textContent = '‚ùå Not connected';
            document.getElementById('connect-section').style.display = 'block';
            document.getElementById('connected-section').style.display = 'none';
        }

        // DIRECT REDIRECT - NO POPUP!
        function connect() {
            console.log('Direct redirect to Oura OAuth2...');
            window.location = generateAuthUrl();  // PURE REDIRECT
        }

        // Reconnect
        function reconnect() {
            clearSettings();
            window.location = generateAuthUrl();  // PURE REDIRECT
        }

        // Send settings to Pebble
        function sendToPebble(token) {
            try {
                // Get current layout configuration
                var savedLayout = localStorage.getItem('oura_measurement_layout');
                var layoutConfig = { left: '0', middle: '1', right: '2' }; // defaults
                if (savedLayout) {
                    try {
                        layoutConfig = JSON.parse(savedLayout);
                    } catch (e) {
                        debugLog('‚ö†Ô∏è Error parsing saved layout, using defaults');
                    }
                }
                
                // Get date format setting
                var dateFormat = localStorage.getItem('oura_date_format') || '0';
                
                // Get theme mode setting
                var themeMode = localStorage.getItem('oura_theme_mode') || '0';
                
                // Get custom color data if theme mode is custom color
                var customColorData = null;
                if (themeMode === '2') {
                    var savedColor = localStorage.getItem('oura_custom_color');
                    if (savedColor) {
                        try {
                            customColorData = JSON.parse(savedColor);
                        } catch (e) {
                            console.log('Error parsing custom color data:', e);
                        }
                    }
                }
                
                var settings = { 
                    oura_access_token: token,
                    layout_left: parseInt(layoutConfig.left),
                    layout_middle: parseInt(layoutConfig.middle),
                    layout_right: parseInt(layoutConfig.right),
                    date_format: parseInt(dateFormat),
                    theme_mode: parseInt(themeMode)
                };

                // Add custom color fields if available
                if (customColorData) {
                    settings.custom_color_index = customColorData.index;
                    settings.custom_color_name = customColorData.name;
                    settings.custom_color_hex = customColorData.hex;
                    settings.custom_color_pebble = customColorData.pebble;
                }
                var returnUrl = 'pebblejs://close#' + encodeURIComponent(JSON.stringify(settings));
                
                debugLog('üì± Sending settings to Pebble:');
                debugLog('Token: ' + token.substring(0, 10) + '...' + token.substring(token.length - 6));
                debugLog('Layout: L=' + layoutConfig.left + ' M=' + layoutConfig.middle + ' R=' + layoutConfig.right);
                debugLog('Settings: ' + JSON.stringify(settings));
                debugLog('Return URL: ' + returnUrl);
                
                // Perform the close immediately when user requests send
                window.location = returnUrl;
            } catch (error) {
                debugLog('‚ùå Error sending to Pebble: ' + error.message);
                console.log('Could not return to Pebble (expected in browser)');
            }
        }

        function resendToPebble() {
            var token = localStorage.getItem('oura_access_token');
            if (!token) { debugLog('‚ùå Resend failed: no token in storage'); return; }
            debugLog('üîÅ Manual resend to Pebble requested');
            sendToPebble(token);
        }

        function sendAndClose() {
            var token = localStorage.getItem('oura_access_token');
            if (!token) { debugLog('‚ùå Send failed: no token in storage'); return; }
            sendToPebble(token);
        }

        function closeWebview() {
            try {
                debugLog('üîí Closing webview without sending');
                window.location = 'pebblejs://close#' + encodeURIComponent(JSON.stringify({}));
            } catch (e) {
                debugLog('‚ùå Close failed (likely in normal browser): ' + e.message);
            }
        }

        function clearSettings() {
            localStorage.removeItem('oura_access_token');
            localStorage.removeItem('oura_token_expires');
            document.getElementById('debug-log').textContent = 'Debug information will appear here...';
            showDisconnected();
            updateDevPanel();
            renderTokenDetails();
            clearApiResults();
            debugLog('üßπ Cleared stored settings');
        }

        // Debug logging function with HTML sanitization
        function debugLog(message) {
            var timestamp = new Date().toLocaleTimeString();
            var logElement = document.getElementById('debug-log');
            if (!logElement) return;
            
            // Sanitize message to prevent HTML injection
            var sanitized = String(message || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            // Truncate very long messages that might contain full HTML pages
            if (sanitized.length > 500) {
                sanitized = sanitized.substring(0, 500) + '... [truncated]';
            }
            
            logElement.textContent += '[' + timestamp + '] ' + sanitized + '\n';
            logElement.scrollTop = logElement.scrollHeight;
        }

        function copyLog() {
            var logElement = document.getElementById('debug-log');
            var statusEl = document.getElementById('copy-status');
            if (!logElement) return;
            var text = logElement.innerText || logElement.textContent || '';
            if (!text) {
                if (statusEl) { statusEl.style.display = 'block'; statusEl.textContent = 'Log is empty'; }
                setTimeout(function(){ if (statusEl) statusEl.style.display = 'none'; }, 1500);
                return;
            }
            var onSuccess = function(){
                if (statusEl) { statusEl.style.display = 'block'; statusEl.textContent = 'Copied!'; }
                debugLog(' Log copied to clipboard');
                setTimeout(function(){ if (statusEl) statusEl.style.display = 'none'; }, 1200);
            };
            var onFail = function(err){
                if (statusEl) { statusEl.style.display = 'block'; statusEl.textContent = 'Copy failed'; }
                debugLog(' Copy failed: ' + (err && err.message ? err.message : 'unknown error'));
                setTimeout(function(){ if (statusEl) statusEl.style.display = 'none'; }, 1500);
            };
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(onSuccess).catch(onFail);
            } else {
                // Fallback
                try {
                    var ta = document.createElement('textarea');
                    ta.value = text;
                    ta.setAttribute('readonly', '');
                    ta.style.position = 'absolute';
                    ta.style.left = '-9999px';
                    document.body.appendChild(ta);
                    ta.select();
                    var ok = document.execCommand('copy');
                    document.body.removeChild(ta);
                    if (ok) onSuccess(); else onFail();
                } catch (e) { onFail(e); }
            }
        }

        // Test Oura API with current token
        function testOuraAPI() {
            var token = localStorage.getItem('oura_access_token');
            
            if (!token) {
                debugLog('‚ùå No token found in localStorage');
                appendApiResult('Direct API Test', 'No Token', 'Please authenticate first.');
                return;
            }
            
            var useProxy = getUseProxySetting() || isPebbleWebView();
            var today = new Date().toISOString().split('T')[0];
            if (useProxy) {
                debugLog('üß™ Testing Oura API via Proxy');
                var pu = 'https://peppy-pothos-093b81.netlify.app/.netlify/functions/oura-proxy?endpoint=heartrate&token=' + encodeURIComponent(token) + '&start_date=' + today + '&end_date=' + today;
                var px = new XMLHttpRequest();
                px.open('GET', pu, true);
                var start = Date.now();
                px.onreadystatechange = function(){
                    if (px.readyState === 4) {
                        var ms = Date.now() - start;
                        debugLog('üì° Proxy Test ‚Üí status ' + px.status + ' in ' + ms + 'ms');
                        appendApiResult('Proxy API Test (heartrate)', px.status, (px.responseText || '').substring(0, 200) + '...');
                        if (px.status === 200) {
                            try { var data = JSON.parse(px.responseText); debugLog('‚úÖ Proxy OK - Data count: ' + (data.data ? data.data.length : 0)); } catch(e){ debugLog('‚ùå Proxy JSON Parse Error: ' + e.message); }
                        } else if (px.status === 401) {
                            debugLog('‚ö†Ô∏è Proxy 401: token expired or missing required scope');
                        }
                    }
                };
                px.send();
                return;
            }

            debugLog('üß™ Testing Oura API directly (browser request)');
            var xhr = new XMLHttpRequest();
            var url = 'https://api.ouraring.com/v2/usercollection/heartrate?start_date=' + today + '&end_date=' + today;
            xhr.open('GET', url, true);
            xhr.setRequestHeader('Authorization', 'Bearer ' + token);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    debugLog('üìä Heart Rate API Response:');
                    debugLog('Status: ' + xhr.status);
                    debugLog('Response (first 200): ' + (xhr.responseText || '').substring(0, 200) + '...');
                    appendApiResult('Direct API Test (heartrate)', xhr.status, (xhr.responseText || '').substring(0, 200) + '...');
                    if (xhr.status === 0) {
                        debugLog('‚ÑπÔ∏è Status 0 usually indicates the Pebble webview blocked the request (CORS/TLS). Use the Proxy toggle.');
                    }
                    if (xhr.status === 200) {
                        try { var data2 = JSON.parse(xhr.responseText); debugLog('‚úÖ API Success - Data count: ' + (data2.data ? data2.data.length : 0)); } catch (e) { debugLog('‚ùå JSON Parse Error: ' + e.message); }
                    } else {
                        debugLog('‚ùå API Error: ' + xhr.status + ' - ' + xhr.statusText);
                    }
                }
            };
            xhr.send();
        }

        function maskToken(t) {
            if (!t) return '(none)';
            if (t.length <= 14) return t;
            return t.substring(0, 8) + '...' + t.substring(t.length - 6);
        }

        function renderTokenDetails() {
            var token = localStorage.getItem('oura_access_token');
            var expires = localStorage.getItem('oura_token_expires');
            var el = document.getElementById('token-details');
            if (!el) return;
            if (!token) {
                el.innerHTML = '<div class="warn">No token in storage.</div>';
                return;
            }
            var expText = '(n/a)';
            if (expires) {
                var expMs = parseInt(expires, 10);
                var delta = expMs - Date.now();
                var mins = Math.max(0, Math.floor(delta / 60000));
                expText = new Date(expMs).toLocaleString() + '  (' + mins + ' min left)';
            }
            el.innerHTML = '' +
                '<div><strong>Masked Token:</strong> ' + maskToken(token) + '</div>' +
                '<div><strong>Scopes:</strong> ' + SCOPES + '</div>' +
                '<div><strong>Expires:</strong> ' + expText + '</div>';
        }

        function clearApiResults() {
            var r = document.getElementById('api-test-results');
            if (r) r.innerHTML = '';
        }

        function appendApiResult(title, status, bodySnippet) {
            var r = document.getElementById('api-test-results');
            if (!r) return;
            
            // Enhanced sanitization and truncation
            var body = String(bodySnippet || '');
            // If it looks like HTML (starts with DOCTYPE or <html), truncate heavily
            if (/^\s*<!DOCTYPE|^\s*<html/i.test(body)) {
                body = '[HTML Response - likely error page] ' + body.substring(0, 100) + '...';
            } else if (body.length > 300) {
                body = body.substring(0, 300) + '... [truncated]';
            }
            var safeBody = body.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            var row = '<div style="margin:6px 0;">' +
                      '<div><strong>' + title + ':</strong> status ' + status + '</div>' +
                      (safeBody ? '<pre style="white-space:pre-wrap;word-break:break-word;background:#f8f9fa;border:1px solid #e9ecef;padding:8px;border-radius:4px;margin:6px 0 0 0;">' + safeBody + '</pre>' : '') +
                      '</div>';
            r.innerHTML = r.innerHTML + row;
        }

        function isPebbleWebView() {
            var ua = (navigator.userAgent || '').toLowerCase();
            return /pebble|rebble/.test(ua);
        }

        function getUseProxySetting() {
            var el = document.getElementById('use-proxy-toggle');
            if (!el) return false;
            return !!el.checked;
        }

        function setUseProxyDefault() {
            var el = document.getElementById('use-proxy-toggle');
            if (!el) return;
            // Default ON in Pebble webview; OFF in normal desktop browser
            var def = isPebbleWebView();
            el.checked = def;
            el.addEventListener('change', function(){
                // no-op for now; could persist if desired
            });
        }

        function updateDevPanel() {
            var kv = document.getElementById('dev-kv');
            if (!kv) return;
            var token = localStorage.getItem('oura_access_token');
            var expires = localStorage.getItem('oura_token_expires');
            var ua = navigator.userAgent || '';
            var inPebble = /pebble|watch|mobile safari/i.test(ua);
            var expText = '(n/a)';
            if (expires) {
                var expMs = parseInt(expires, 10);
                var delta = expMs - Date.now();
                var mins = Math.max(0, Math.floor(delta / 60000));
                expText = new Date(expMs).toLocaleString() + '  (' + mins + ' min left)';
            }
            kv.innerHTML = '' +
                '<div>Env</div><div>' + (inPebble ? '<span class="ok">Pebble WebView</span>' : ua) + '</div>' +
                '<div>Scopes</div><div>' + SCOPES + '</div>' +
                '<div>Token</div><div>' + maskToken(token) + '</div>' +
                '<div>Expires</div><div>' + expText + '</div>' +
                '<div>Redirect URI</div><div>' + REDIRECT_URI + '</div>' +
                '<div>Auth URL</div><div>' + AUTH_URL + '</div>';
        }

        function autoProxySmokeTest() {
            var token = localStorage.getItem('oura_access_token');
            if (!token) return;
            var today = new Date().toISOString().split('T')[0];
            var u = 'https://peppy-pothos-093b81.netlify.app/.netlify/functions/oura-proxy?endpoint=heartrate&token=' + encodeURIComponent(token) + '&start_date=' + today + '&end_date=' + today;
            var xhr = new XMLHttpRequest();
            var started = Date.now();
            xhr.open('GET', u, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    var ms = Date.now() - started;
                    debugLog('üõ∞Ô∏è Proxy smoke test ‚Üí status ' + xhr.status + ' in ' + ms + 'ms');
                    appendApiResult('Proxy Smoke Test', xhr.status, (xhr.responseText || '').substring(0, 200) + '...');
                    if (xhr.status !== 200) {
                        debugLog('‚Ü™Ô∏é Body (first 200): ' + (xhr.responseText || '').substring(0, 200) + '...');
                        if (xhr.status === 401) {
                            debugLog('‚ö†Ô∏è Token likely missing required scope ("heartrate") or expired');
                        }
                    }
                }
            };
            xhr.send();
        }

        // Check all stored data
        function checkStoredData() {
            debugLog('üîç Checking localStorage data:');
            
            var keys = ['oura_access_token', 'oura_token_expires', 'oura_config_settings', 'oura_last_update'];
            
            keys.forEach(function(key) {
                var value = localStorage.getItem(key);
                if (value) {
                    if (key === 'oura_access_token') {
                        debugLog(key + ': ' + value.substring(0, 10) + '...' + value.substring(value.length - 6));
                    } else if (key === 'oura_token_expires') {
                        var expires = new Date(parseInt(value));
                        var now = new Date();
                        var isExpired = now > expires;
                        debugLog(key + ': ' + expires.toLocaleString() + ' (Expired: ' + isExpired + ')');
                    } else {
                        debugLog(key + ': ' + value);
                    }
                } else {
                    debugLog(key + ': (not set)');
                }
            });
            
            // Check token validity
            var token = localStorage.getItem('oura_access_token');
            var expires = localStorage.getItem('oura_token_expires');
            
            if (token && expires) {
                var isValid = Date.now() < parseInt(expires);
                debugLog('üîê Token Status: ' + (isValid ? 'VALID' : 'EXPIRED'));
            }
        }

        // Clear debug log
        function clearDebugLog() {
            document.getElementById('debug-log').textContent = 'Debug information will appear here...';
        }

        // Initialize debug section as hidden by default
        function initializeDebugVisibility() {
            var debugSection = document.querySelector('.debug-section');
            var showDebug = document.getElementById('show-debug').checked;
            
            // Hide debug section by default
            if (debugSection) {
                debugSection.style.display = showDebug ? 'block' : 'none';
            }
        }
        
        // Update construction banner with current date
        function updateConstructionDate() {
            var constructionDateElement = document.getElementById('construction-date');
            if (constructionDateElement) {
                var now = new Date();
                var dateString = now.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                constructionDateElement.textContent = dateString + ' - Some features may experience issues, delays, or unexpected behavior';
            }
        }
        
        // Load saved date format setting
        function loadSavedDateFormat() {
            var savedDateFormat = localStorage.getItem('oura_date_format');
            if (savedDateFormat !== null) {
                var dateFormatSelect = document.getElementById('date-format');
                if (dateFormatSelect) {
                    dateFormatSelect.value = savedDateFormat;
                }
            }
        }
        
        // Save date format setting
        function saveDateFormat() {
            var dateFormatSelect = document.getElementById('date-format');
            if (dateFormatSelect) {
                localStorage.setItem('oura_date_format', dateFormatSelect.value);
                debugLog('üìÖ Date format saved: ' + (dateFormatSelect.value === '0' ? 'MM-DD-YYYY' : 'DD-MM-YYYY'));
            }
        }
        
        // Load saved theme mode setting
        function loadSavedThemeMode() {
            var savedThemeMode = localStorage.getItem('oura_theme_mode');
            if (savedThemeMode !== null) {
                var themeModeSelect = document.getElementById('theme-mode');
                if (themeModeSelect) {
                    themeModeSelect.value = savedThemeMode;
                    // Also reflect visibility immediately
                    var colorPickerSection = document.getElementById('color-picker-section');
                    if (colorPickerSection) {
                        colorPickerSection.style.display = (savedThemeMode === '2') ? 'block' : 'none';
                    }
                }
            }
        }
        
        // Save theme mode setting
        function saveThemeMode() {
            var themeModeSelect = document.getElementById('theme-mode');
            if (themeModeSelect) {
                localStorage.setItem('oura_theme_mode', themeModeSelect.value);
                // Robustly toggle color picker visibility here as well
                var colorPickerSection = document.getElementById('color-picker-section');
                if (colorPickerSection) {
                    colorPickerSection.style.display = (themeModeSelect.value === '2') ? 'block' : 'none';
                }
                debugLog('üé® Theme mode saved: ' + (themeModeSelect.value === '0' ? 'üåô Dark Mode' : (themeModeSelect.value === '1' ? '‚òÄÔ∏è Light Mode' : 'üé® Custom Color')));
            }
        }
        
        // Initialize - PURE STATIC, NO DYNAMIC LOADING
        document.addEventListener('DOMContentLoaded', function() {
            // Update construction banner with current date
            updateConstructionDate();
            
            // Initialize debug visibility
            initializeDebugVisibility();
            
            // Initialize measurement layout
            loadSavedMeasurementLayout();
            
            // Load saved date format
            loadSavedDateFormat();
            
            // Load saved theme mode
            loadSavedThemeMode();
            
            // Add date format change listener
            var dateFormatSelect = document.getElementById('date-format');
            if (dateFormatSelect) {
                dateFormatSelect.addEventListener('change', saveDateFormat);
            }
            
            // Add theme mode change listener
            var themeModeSelect = document.getElementById('theme-mode');
            if (themeModeSelect) {
                themeModeSelect.addEventListener('change', saveThemeMode);
            }
            
            // Add smart duplicate prevention event listeners
            document.getElementById('left-position').addEventListener('change', function() {
                preventDuplicates('left-position');
                updateMeasurementLayout();
            });
            document.getElementById('middle-position').addEventListener('change', function() {
                preventDuplicates('middle-position');
                updateMeasurementLayout();
            });
            document.getElementById('right-position').addEventListener('change', function() {
                preventDuplicates('right-position');
                updateMeasurementLayout();
            });
            
            debugLog('üöÄ Config page loaded');
            debugLog('Current URL: ' + window.location.href);
            debugLog('Requested OAuth scopes: ' + SCOPES);
            updateDevPanel();
            renderTokenDetails();
            clearApiResults();
            setUseProxyDefault();
            
            // Always initialize UI subsystems regardless of auth state
            // Ensures color picker visibility/behavior, theme mode handling,
            // and flexible layout controls work even when a token is present
            initializeColorPicker();
            setupThemeModeHandler();
            setupFlexibleLayout();
            // Ensure Row 2 selectors visibility matches dropdown immediately
            if (typeof updateRowSelectorsVisibility === 'function') {
                updateRowSelectorsVisibility();
            }
            
            // Check for OAuth redirect
            debugLog('üîç Checking for OAuth redirect token...');
            if (checkForToken()) {
                debugLog('‚úÖ Token found in URL redirect');
                updateDevPanel();
                renderTokenDetails();
                autoProxySmokeTest();
                return;
            }
            
            // Check for stored token
            debugLog('üîç Checking for stored token...');
            if (checkStoredToken()) {
                debugLog('‚úÖ Valid stored token found');
                updateDevPanel();
                renderTokenDetails();
                autoProxySmokeTest();
                return;
            }
            
            // Show connect section
            debugLog('‚ùå No valid token found - showing connect section');
            showDisconnected();
            
            // Set up connect button - DIRECT REDIRECT ONLY
            document.getElementById('connect-btn').onclick = connect;
            
            // Log initial state
            debugLog('üìã Initial localStorage check:');
            checkStoredData();
            updateDevPanel();
            renderTokenDetails();
            clearApiResults();
        });
        
        // ===== COLOR PICKER FUNCTIONALITY =====
        
        // Complete Pebble Color Palette (64 colors)
        var pebbleColors = [
            { name: 'Black', hex: '#000000', pebble: 'GColorBlack' },
            { name: 'Oxford Blue', hex: '#0F2E4C', pebble: 'GColorOxfordBlue' },
            { name: 'Duke Blue', hex: '#003D82', pebble: 'GColorDukeBlue' },
            { name: 'Blue', hex: '#0055FF', pebble: 'GColorBlue' },
            { name: 'Dark Green', hex: '#005500', pebble: 'GColorDarkGreen' },
            { name: 'Midnight Green', hex: '#004C5C', pebble: 'GColorMidnightGreen' },
            { name: 'Cobalt Blue', hex: '#0066FF', pebble: 'GColorCobaltBlue' },
            { name: 'Blue Moon', hex: '#68A3FF', pebble: 'GColorBlueMoon' },
            { name: 'Islamic Green', hex: '#00AA00', pebble: 'GColorIslamicGreen' },
            { name: 'Jaeger Green', hex: '#00AA55', pebble: 'GColorJaegerGreen' },
            { name: 'Tiffany Blue', hex: '#00AAAA', pebble: 'GColorTiffanyBlue' },
            { name: 'Vivid Cerulean', hex: '#00AAFF', pebble: 'GColorVividCerulean' },
            { name: 'Green', hex: '#00FF00', pebble: 'GColorGreen' },
            { name: 'Malachite', hex: '#00FF55', pebble: 'GColorMalachite' },
            { name: 'Medium Spring Green', hex: '#00FFAA', pebble: 'GColorMediumSpringGreen' },
            { name: 'Cyan', hex: '#00FFFF', pebble: 'GColorCyan' },
            { name: 'Bulgarian Rose', hex: '#550000', pebble: 'GColorBulgarianRose' },
            { name: 'Imperial Purple', hex: '#550055', pebble: 'GColorImperialPurple' },
            { name: 'Indigo', hex: '#5500AA', pebble: 'GColorIndigo' },
            { name: 'Electric Ultramarine', hex: '#5500FF', pebble: 'GColorElectricUltramarine' },
            { name: 'Army Green', hex: '#555500', pebble: 'GColorArmyGreen' },
            { name: 'Dark Gray', hex: '#555555', pebble: 'GColorDarkGray' },
            { name: 'Liberty', hex: '#5555AA', pebble: 'GColorLiberty' },
            { name: 'Very Light Blue', hex: '#5555FF', pebble: 'GColorVeryLightBlue' },
            { name: 'Kelly Green', hex: '#55AA00', pebble: 'GColorKellyGreen' },
            { name: 'May Green', hex: '#55AA55', pebble: 'GColorMayGreen' },
            { name: 'Cadet Blue', hex: '#55AAAA', pebble: 'GColorCadetBlue' },
            { name: 'Picton Blue', hex: '#55AAFF', pebble: 'GColorPictonBlue' },
            { name: 'Bright Green', hex: '#55FF00', pebble: 'GColorBrightGreen' },
            { name: 'Screamin Green', hex: '#55FF55', pebble: 'GColorScreaminGreen' },
            { name: 'Medium Aquamarine', hex: '#55FFAA', pebble: 'GColorMediumAquamarine' },
            { name: 'Electric Blue', hex: '#55FFFF', pebble: 'GColorElectricBlue' },
            { name: 'Dark Candyapple Red', hex: '#AA0000', pebble: 'GColorDarkCandyappleRed' },
            { name: 'Jazzberry Jam', hex: '#AA0055', pebble: 'GColorJazzberryJam' },
            { name: 'Purple', hex: '#AA00AA', pebble: 'GColorPurple' },
            { name: 'Vivid Violet', hex: '#AA00FF', pebble: 'GColorVividViolet' },
            { name: 'Windsor Tan', hex: '#AA5500', pebble: 'GColorWindsorTan' },
            { name: 'Rose Vale', hex: '#AA5555', pebble: 'GColorRoseVale' },
            { name: 'Purpureus', hex: '#AA55AA', pebble: 'GColorPurpureus' },
            { name: 'Lavender Indigo', hex: '#AA55FF', pebble: 'GColorLavenderIndigo' },
            { name: 'Limerick', hex: '#AAAA00', pebble: 'GColorLimerick' },
            { name: 'Brass', hex: '#AAAA55', pebble: 'GColorBrass' },
            { name: 'Light Gray', hex: '#AAAAAA', pebble: 'GColorLightGray' },
            { name: 'Baby Blue Eyes', hex: '#AAAAFF', pebble: 'GColorBabyBlueEyes' },
            { name: 'Spring Bud', hex: '#AAFF00', pebble: 'GColorSpringBud' },
            { name: 'Inchworm', hex: '#AAFF55', pebble: 'GColorInchworm' },
            { name: 'Mint Green', hex: '#AAFFAA', pebble: 'GColorMintGreen' },
            { name: 'Celeste', hex: '#AAFFFF', pebble: 'GColorCeleste' },
            { name: 'Red', hex: '#FF0000', pebble: 'GColorRed' },
            { name: 'Folly', hex: '#FF0055', pebble: 'GColorFolly' },
            { name: 'Fashion Magenta', hex: '#FF00AA', pebble: 'GColorFashionMagenta' },
            { name: 'Magenta', hex: '#FF00FF', pebble: 'GColorMagenta' },
            { name: 'Orange', hex: '#FF5500', pebble: 'GColorOrange' },
            { name: 'Sunset Orange', hex: '#FF5555', pebble: 'GColorSunsetOrange' },
            { name: 'Brilliant Rose', hex: '#FF55AA', pebble: 'GColorBrilliantRose' },
            { name: 'Shocking Pink', hex: '#FF55FF', pebble: 'GColorShockingPink' },
            { name: 'Chromecast Yellow', hex: '#FFAA00', pebble: 'GColorChromeYellow' },
            { name: 'Rajah', hex: '#FFAA55', pebble: 'GColorRajah' },
            { name: 'Melon', hex: '#FFAAAA', pebble: 'GColorMelon' },
            { name: 'Rich Brilliant Lavender', hex: '#FFAAFF', pebble: 'GColorRichBrilliantLavender' },
            { name: 'Yellow', hex: '#FFFF00', pebble: 'GColorYellow' },
            { name: 'Icterine', hex: '#FFFF55', pebble: 'GColorIcterine' },
            { name: 'Pastel Yellow', hex: '#FFFFAA', pebble: 'GColorPastelYellow' },
            { name: 'White', hex: '#FFFFFF', pebble: 'GColorWhite' }
        ];
        
        // Initialize color picker
        function initializeColorPicker() {
            var colorPalette = document.getElementById('color-palette');
            if (!colorPalette) return;
            
            // Create color swatches
            pebbleColors.forEach(function(color, index) {
                var swatch = document.createElement('div');
                swatch.style.cssText = 
                    'width: 45px; height: 45px; background: ' + color.hex + '; ' +
                    'border: 2px solid #ddd; border-radius: 6px; cursor: pointer; ' +
                    'transition: all 0.2s ease; position: relative; ' +
                    'touch-action: manipulation; min-height: 44px; min-width: 44px;';
                
                swatch.title = color.name;
                swatch.onclick = function() { selectColor(index); };
                
                // Hover effects
                swatch.onmouseenter = function() {
                    this.style.transform = 'scale(1.1)';
                    this.style.borderColor = '#007bff';
                    this.style.zIndex = '10';
                };
                swatch.onmouseleave = function() {
                    this.style.transform = 'scale(1)';
                    this.style.borderColor = '#ddd';
                    this.style.zIndex = '1';
                };
                
                colorPalette.appendChild(swatch);
            });
            
            // Load saved color selection
            loadSavedColor();
        }
        
        // Select a color from the palette
        function selectColor(colorIndex) {
            var color = pebbleColors[colorIndex];
            if (!color) return;
            
            // Update preview
            var preview = document.getElementById('color-preview');
            var colorName = document.getElementById('color-name');
            
            preview.style.background = color.hex;
            preview.style.color = getContrastColor(color.hex);
            colorName.textContent = color.name;
            
            // Save selection
            localStorage.setItem('oura_custom_color', JSON.stringify({
                index: colorIndex,
                name: color.name,
                hex: color.hex,
                pebble: color.pebble
            }));
            
            // Update theme mode to custom color
            document.getElementById('theme-mode').value = '2';
            localStorage.setItem('oura_theme_mode', '2');
            
            debugLog('üé® Selected color: ' + color.name + ' (' + color.hex + ')');
        }
        
        // Load saved color selection
        function loadSavedColor() {
            var saved = localStorage.getItem('oura_custom_color');
            if (saved) {
                try {
                    var colorData = JSON.parse(saved);
                    selectColor(colorData.index);
                } catch (e) {
                    console.log('Error loading saved color:', e);
                    selectColor(0); // Default to black
                }
            } else {
                selectColor(0); // Default to black
            }
        }
        
        // Calculate contrast color for text readability
        function getContrastColor(hexColor) {
            // Convert hex to RGB
            var r = parseInt(hexColor.substr(1, 2), 16);
            var g = parseInt(hexColor.substr(3, 2), 16);
            var b = parseInt(hexColor.substr(5, 2), 16);
            
            // Calculate luminance
            var luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            
            // Return black or white based on luminance
            return luminance > 0.5 ? '#000000' : '#FFFFFF';
        }
        
        // Setup theme mode change handler
        function setupThemeModeHandler() {
            var themeModeSelect = document.getElementById('theme-mode');
            var colorPickerSection = document.getElementById('color-picker-section');
            
            if (!themeModeSelect || !colorPickerSection) {
                debugLog('‚ùå Theme mode elements not found - themeModeSelect: ' + !!themeModeSelect + ', colorPickerSection: ' + !!colorPickerSection);
                return;
            }
            
            debugLog('‚úÖ Theme mode handler initialized');
            
            // Function to update color picker visibility
            function updateColorPickerVisibility(selectedMode) {
                debugLog('üé® Updating color picker visibility for mode: ' + selectedMode);
                if (selectedMode === '2') { // Custom Color
                    colorPickerSection.style.display = 'block';
                    debugLog('üé® Color picker shown');
                } else {
                    colorPickerSection.style.display = 'none';
                    debugLog('üé® Color picker hidden');
                }
            }
            
            // Add change event listener
            themeModeSelect.addEventListener('change', function() {
                var selectedMode = this.value;
                updateColorPickerVisibility(selectedMode);
                
                // Save theme mode
                localStorage.setItem('oura_theme_mode', selectedMode);
                debugLog('üé® Theme mode changed to: ' + selectedMode);
            });
            
            // Load saved theme mode and update visibility
            var savedThemeMode = localStorage.getItem('oura_theme_mode') || '0';
            themeModeSelect.value = savedThemeMode;
            updateColorPickerVisibility(savedThemeMode);
            
            debugLog('üé® Theme mode loaded: ' + savedThemeMode);
        }
        
        // ===== FLEXIBLE LAYOUT SYSTEM =====
        
        // Setup flexible layout system
        function setupFlexibleLayout() {
            var layoutRowsSelect = document.getElementById('layout-rows');
            if (!layoutRowsSelect) return;
            
            // Add event listener for layout rows change
            layoutRowsSelect.addEventListener('change', function() {
                updateRowSelectorsVisibility();
                saveLayoutConfiguration();
            });
            
            // Load saved layout configuration
            loadSavedLayoutConfiguration();
            
            // Update visibility based on current selection
            updateRowSelectorsVisibility();
        }
        
        // Update visibility of Row 2 selectors based on layout selection
        function updateRowSelectorsVisibility() {
            var layoutRows = document.getElementById('layout-rows').value;
            var row2Selectors = document.getElementById('row2-selectors');
            
            if (layoutRows === '2') {
                row2Selectors.style.display = 'block';
                debugLog('üìê Showing Row 2 selectors for 2-row layout');
            } else {
                row2Selectors.style.display = 'none';
                debugLog('üìê Hiding Row 2 selectors for 1-row layout');
            }
        }
        
        // Save layout configuration to localStorage
        function saveLayoutConfiguration() {
            var layoutRows = document.getElementById('layout-rows').value;
            var row1Left = document.getElementById('left-position').value;
            var row1Middle = document.getElementById('middle-position').value;
            var row1Right = document.getElementById('right-position').value;
            var row2Left = document.getElementById('row2-left-position').value;
            var row2Right = document.getElementById('row2-right-position').value;
            
            var layoutConfig = {
                rows: parseInt(layoutRows),
                row1: {
                    left: parseInt(row1Left),
                    middle: parseInt(row1Middle),
                    right: parseInt(row1Right)
                },
                row2: {
                    left: parseInt(row2Left),
                    right: parseInt(row2Right)
                }
            };
            
            localStorage.setItem('oura_flexible_layout', JSON.stringify(layoutConfig));
            debugLog('üìê Saved flexible layout configuration: ' + JSON.stringify(layoutConfig));
        }
        
        // Load saved layout configuration
        function loadSavedLayoutConfiguration() {
            var saved = localStorage.getItem('oura_flexible_layout');
            if (saved) {
                try {
                    var config = JSON.parse(saved);
                    
                    // Set layout rows
                    document.getElementById('layout-rows').value = config.rows.toString();
                    // Ensure row2 selectors visibility matches saved rows
                    if (typeof updateRowSelectorsVisibility === 'function') {
                        updateRowSelectorsVisibility();
                    }
                    
                    // Set Row 1 positions
                    document.getElementById('left-position').value = config.row1.left.toString();
                    document.getElementById('middle-position').value = config.row1.middle.toString();
                    document.getElementById('right-position').value = config.row1.right.toString();
                    
                    // Set Row 2 positions
                    document.getElementById('row2-left-position').value = config.row2.left.toString();
                    document.getElementById('row2-right-position').value = config.row2.right.toString();
                    
                    debugLog('üìê Loaded flexible layout configuration: ' + JSON.stringify(config));
                } catch (e) {
                    console.log('Error loading flexible layout configuration:', e);
                    setDefaultFlexibleLayout();
                }
            } else {
                setDefaultFlexibleLayout();
            }
        }
        
        // Set default flexible layout configuration
        function setDefaultFlexibleLayout() {
            // Default: 1 row with Readiness, Sleep, Heart Rate
            document.getElementById('layout-rows').value = '1';
            document.getElementById('left-position').value = '0';  // Readiness
            document.getElementById('middle-position').value = '1';  // Sleep
            document.getElementById('right-position').value = '2';  // Heart Rate
            
            // Default Row 2: Activity, Stress
            document.getElementById('row2-left-position').value = '3';  // Activity
            document.getElementById('row2-right-position').value = '4';  // Stress
            
            saveLayoutConfiguration();
            debugLog('üìê Set default flexible layout configuration');
        }
    </script>
</body>
</html>
