<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oura Stats - Pebble Configuration</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            transition: background-color 0.3s ease, color 0.3s ease;
            padding-bottom: 80px; /* Space for sticky navbar */
        }
        
        body.dark-mode {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        
        /* Sticky Navbar */
        .sticky-navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #fff;
            border-bottom: 1px solid #ddd;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        body.dark-mode .sticky-navbar {
            background: #2a2a2a;
            border-bottom-color: #555;
        }
        
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .theme-toggle-slider {
            width: 50px;
            height: 24px;
            background: #ccc;
            border-radius: 20px;
            position: relative;
            transition: background-color 0.3s ease;
        }
        
        .theme-toggle-slider::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s ease;
        }
        
        body.dark-mode .theme-toggle-slider {
            background: #0066cc;
        }
        
        body.dark-mode .theme-toggle-slider::before {
            transform: translateX(26px);
        }
        
        .navbar-buttons {
            display: flex;
            gap: 8px;
        }
        
        .save-btn, .close-btn, .reset-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }
        
        .save-btn {
            background: #28a745;
            color: white;
        }
        
        .save-btn:hover:not(:disabled) {
            background: #218838;
        }
        
        .save-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .save-btn.has-changes {
            background: #ffc107;
            color: #212529;
        }
        
        .save-btn.has-changes:hover {
            background: #e0a800;
        }
        
        .close-btn {
            background: #007bff;
            color: white;
        }
        
        .close-btn:hover {
            background: #0056b3;
        }

        .reset-btn {
            background: #dc3545;
            color: white;
        }

        .reset-btn:hover {
            background: #c82333;
        }
        
        /* Main Content */
        .main-content {
            margin-top: 60px;
            padding: 20px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        body.dark-mode .tab-nav {
            background: #2a2a2a;
        }
        
        .tab-button {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #666;
        }
        
        body.dark-mode .tab-button {
            color: #aaa;
        }
        
        .tab-button.active {
            background: #007bff;
            color: white;
        }
        
        .tab-button:hover:not(.active) {
            background: #f8f9fa;
        }
        
        body.dark-mode .tab-button:hover:not(.active) {
            background: #333;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Collapsible Sections */
        .collapsible-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 16px;
            overflow: hidden;
        }
        
        body.dark-mode .collapsible-section {
            background: #2a2a2a;
        }
        
        .section-header {
            padding: 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s ease;
        }
        
        body.dark-mode .section-header {
            border-bottom-color: #444;
        }
        
        .section-header:hover {
            background: #f8f9fa;
        }
        
        body.dark-mode .section-header:hover {
            background: #333;
        }
        
        .section-header .toggle-icon {
            transition: transform 0.3s ease;
        }
        
        .section-header.expanded .toggle-icon {
            transform: rotate(180deg);
        }
        
        .section-content {
            padding: 0 16px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        
        .section-content.expanded {
            padding: 16px;
            max-height: 1000px;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group:last-child {
            margin-bottom: 0;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
        }
        
        select, input[type="number"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            color: #333;
        }
        
        body.dark-mode select, body.dark-mode input[type="number"] {
            background: #444;
            color: #e0e0e0;
            border-color: #666;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        
        .connect-btn {
            width: 100%;
            padding: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        
        .connect-btn:hover {
            background: #218838;
        }
        
        /* Color Picker */
        .color-picker {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        
        .color-swatch {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .color-swatch:hover {
            transform: scale(1.1);
        }
        
        .color-swatch.selected {
            border-color: #007bff;
            transform: scale(1.1);
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Watchface Preview Styles */
        .preview-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 16px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        
        body.dark-mode .preview-container {
            background: #2a2a2a;
        }
        
        .watchface-preview {
            width: 180px;
            height: 220px;
            border-radius: 16px;
            background-color: #000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
            border: 2px solid #ddd;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', sans-serif;
        }
        
        body.dark-mode .watchface-preview {
            border-color: #555;
        }
        
        .preview-time {
            position: absolute;
            top: 12px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 22px;
            font-weight: bold;
        }
        
        .preview-date {
            position: absolute;
            top: 42px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
        }
        
        .preview-complications {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
        }
        
        .preview-row {
            display: flex;
        }
        
        .preview-row.single-row {
            height: 42px;
        }
        
        .preview-row.dual-row {
            height: 32px;
        }
        
        .preview-complication {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        /* Single row sizing (larger) */
        .preview-row.single-row .preview-value {
            font-size: 18px;
            margin-bottom: 2px;
        }
        
        .preview-row.single-row .preview-label {
            font-size: 14px;
        }
        
        /* Dual row sizing (smaller) */
        .preview-row.dual-row .preview-value {
            font-size: 14px;
            margin-bottom: 1px;
        }
        
        .preview-row.dual-row .preview-label {
            font-size: 12px;
        }
        
        /* Emoji sizing optimization */
        .preview-label.emoji {
            font-size: 16px !important;
            line-height: 1;
        }
        
        .preview-row.dual-row .preview-label.emoji {
            font-size: 14px !important;
        }

        /* Color Picker Styles */
        .color-picker-container {
            display: none;
            margin-top: 12px;
        }
        
        .color-picker-container.visible {
            display: block;
        }
        
        .color-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            margin-top: 8px;
        }
        
        .color-swatch {
            width: 32px;
            height: 32px;
            border: 2px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .color-swatch:hover {
            transform: scale(1.1);
            border-color: #007bff;
        }
        
        .color-swatch.selected {
            border-color: #007bff;
            border-width: 3px;
        }
        
        .color-swatch::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: currentColor;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .color-swatch.selected::after {
            opacity: 1;
        }
        
        .component-color-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }
        
        .color-input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .color-input-group label {
            font-size: 12px;
            margin-bottom: 2px;
        }
        
        /* Support Development Card */
        .support-card {
            background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .support-card h3 {
            margin: 0 0 12px 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .support-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .support-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }
        
        /* Under Construction Card */
        .construction-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .construction-card h3 {
            margin: 0 0 8px 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .construction-card p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }

        /* Connection Button Styles */
        .connect-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
        }
        
        .connect-btn.disconnected {
            background: #007bff;
            color: white;
        }
        
        .connect-btn.disconnected:hover {
            background: #0056b3;
        }
        
        .connect-btn.connected {
            background: #28a745;
            color: white;
        }
        
        .connect-btn.connected:hover {
            background: #1e7e34;
        }
        
        .connect-btn.error {
            background: #dc3545;
            color: white;
        }
        
        .connect-btn.error:hover {
            background: #c82333;
        }
        
        .connection-status {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            margin-top: 8px;
        }
        
        .connection-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .connection-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        body.dark-mode .connection-status.connected {
            background: #1e4d2b;
            color: #d4edda;
            border-color: #2d5a35;
        }
        
        body.dark-mode .connection-status.error {
            background: #4d1e24;
            color: #f8d7da;
            border-color: #5a2d35;
        }

        /* Presets */
        .preset-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        @media (min-width: 430px) {
            .preset-grid { grid-template-columns: 1fr 1fr; }
        }
        @media (min-width: 760px) {
            .preset-grid { grid-template-columns: 1fr 1fr 1fr; }
        }
        .preset-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: #fff;
        }
        body.dark-mode .preset-card {
            border-color: #444;
            background: #2a2a2a;
        }
        .preset-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }
        .preset-title {
            font-weight: 600;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .preset-thumb {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 160px;
        }
        .preset-actions {
            display: flex;
            gap: 6px;
        }
        .preset-actions button {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: #f8f9fa;
            cursor: pointer;
        }
        body.dark-mode .preset-actions button {
            border-color: #555;
            background: #333;
            color: #e0e0e0;
        }
    </style>
</head>
<body>
    <!-- Sticky Navbar -->
    <div class="sticky-navbar">
        <div class="theme-toggle" onclick="toggleTheme()">
            <span>☀️</span>
            <div class="theme-toggle-slider"></div>
            <span>🌙</span>
        </div>
        <div class="navbar-buttons">
            <button class="reset-btn" id="reset-btn" onclick="resetToDefaults()">Reset</button>
            <button class="save-btn" id="save-btn" onclick="saveChanges()" disabled>Save</button>
            <button class="close-btn" onclick="closeConfig()">Save & Close</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-button active" onclick="switchTab('customize')">Customize</button>
            <button class="tab-button" onclick="switchTab('setup')">Setup</button>
            <button class="tab-button" onclick="switchTab('debug')">Debug</button>
        </div>

        <!-- Support Development Card -->
        <div class="support-card">
            <h3>☕ Want to support this development?</h3>
            <a href="https://ko-fi.com/arturojreal" target="_blank" class="support-btn">
                ❤️ Buy me a coffee!
            </a>
        </div>

        <!-- Customize Tab -->
        <div id="customize-tab" class="tab-content active">
            <!-- Display Settings -->
            <div class="collapsible-section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>⚙️ Display Settings</span>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="section-content">
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="show-seconds">
                            <label for="show-seconds">Show Seconds</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="compact-time">
                            <label for="compact-time">Compact Time</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="date-format">Date Format</label>
                        <select id="date-format">
                            <optgroup label="Traditional">
                                <option value="0">08-17-2025</option>
                                <option value="1">17-08-2025</option>
                                <option value="12">2025-08-17</option>
                            </optgroup>
                            <optgroup label="Full Month">
                                <option value="2">August 17, 2025</option>
                                <option value="3">17 August 2025</option>
                                <option value="4">August 17</option>
                                <option value="5">17 August</option>
                            </optgroup>
                            <optgroup label="Short Month">
                                <option value="6">Aug 17, 2025</option>
                                <option value="7">17 Aug 2025</option>
                                <option value="8">Aug 17</option>
                                <option value="9">17 Aug</option>
                            </optgroup>
                            <optgroup label="With Weekday">
                                <option value="10">Saturday, August 17</option>
                                <option value="11">Sat, Aug 17</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Watchface Preview -->
            <div class="collapsible-section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>👁️ Live Preview</span>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="section-content expanded">
                    <div class="preview-container">
                        <div class="watchface-preview" id="watchface-preview">
                            <div class="preview-time" id="preview-time">10:09</div>
                            <div class="preview-date" id="preview-date">Aug 17</div>
                            <div class="preview-complications">
                                <div class="preview-row" id="preview-row1">
                                    <div class="preview-complication">
                                        <div class="preview-value" id="preview-rdy-value">74</div>
                                        <div class="preview-label" id="preview-rdy-label">RDY</div>
                                    </div>
                                    <div class="preview-complication">
                                        <div class="preview-value" id="preview-slp-value">71</div>
                                        <div class="preview-label" id="preview-slp-label">SLP</div>
                                    </div>
                                    <div class="preview-complication">
                                        <div class="preview-value" id="preview-hr-value">68</div>
                                        <div class="preview-label" id="preview-hr-label">HR</div>
                                    </div>
                                </div>
                                <div class="preview-row" id="preview-row2" style="display: none;">
                                    <div class="preview-complication">
                                        <div class="preview-value" id="preview-act-value">85</div>
                                        <div class="preview-label" id="preview-act-label">ACT</div>
                                    </div>
                                    <div class="preview-complication">
                                        <div class="preview-value" id="preview-str-value">2h</div>
                                        <div class="preview-label" id="preview-str-label">STR</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Theme & Colors -->
            <div class="collapsible-section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>🎨 Colors & Display</span>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="section-content">
                    <div class="form-group">
                        <label for="theme-mode">Theme Mode</label>
                        <select id="theme-mode" onchange="onThemeModeChange()">
                            <option value="0">Dark Mode</option>
                            <option value="1">Light Mode</option>
                            <option value="2">Custom Colors</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="use-emoji">
                            <label for="use-emoji">Use Emoji Labels (vs Text)</label>
                        </div>
                    </div>
                    
                    <div class="color-picker-container" id="color-picker">
                        <div class="component-color-group">
                            <div class="color-input-group">
                                <label>Background</label>
                                <select id="background-color" onchange="updatePreview()">
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <div class="color-input-group">
                                <label>Time</label>
                                <select id="time-color" onchange="updatePreview()">
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <div class="color-input-group">
                                <label>Date</label>
                                <select id="date-color" onchange="updatePreview()">
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <div class="color-input-group">
                                <label>Readiness</label>
                                <select id="readiness-color" onchange="updatePreview()">
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <div class="color-input-group">
                                <label>Sleep</label>
                                <select id="sleep-color" onchange="updatePreview()">
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <div class="color-input-group">
                                <label>Heart Rate</label>
                                <select id="heart-rate-color" onchange="updatePreview()">
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <div class="color-input-group">
                                <label>Activity</label>
                                <select id="activity-color" onchange="updatePreview()">
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <div class="color-input-group">
                                <label>Stress</label>
                                <select id="stress-color" onchange="updatePreview()">
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Layout Options -->
            <div class="collapsible-section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>📐 Layout Options</span>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="section-content">
                    <div class="form-group">
                        <label for="layout-rows">Number of Rows</label>
                        <select id="layout-rows" onchange="toggleRow2Options()">
                            <option value="1">1 Row</option>
                            <option value="2">2 Rows</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="layout-left">Left Position</label>
                        <select id="layout-left">
                            <option value="0">Readiness</option>
                            <option value="1">Sleep</option>
                            <option value="2">Heart Rate</option>
                            <option value="3">Activity</option>
                            <option value="4">Stress</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="layout-middle">Middle Position</label>
                        <select id="layout-middle">
                            <option value="0">Readiness</option>
                            <option value="1">Sleep</option>
                            <option value="2">Heart Rate</option>
                            <option value="3">Activity</option>
                            <option value="4">Stress</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="layout-right">Right Position</label>
                        <select id="layout-right">
                            <option value="0">Readiness</option>
                            <option value="1">Sleep</option>
                            <option value="2">Heart Rate</option>
                            <option value="3">Activity</option>
                            <option value="4">Stress</option>
                        </select>
                    </div>
                    <div id="row2-options" class="hidden">
                        <div class="form-group">
                            <label for="layout-row2-left">Row 2 Left</label>
                            <select id="layout-row2-left">
                                <option value="0">Readiness</option>
                                <option value="1">Sleep</option>
                                <option value="2">Heart Rate</option>
                                <option value="3">Activity</option>
                                <option value="4">Stress</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="layout-row2-right">Row 2 Right</label>
                            <select id="layout-row2-right">
                                <option value="0">Readiness</option>
                                <option value="1">Sleep</option>
                                <option value="2">Heart Rate</option>
                                <option value="3">Activity</option>
                                <option value="4">Stress</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Saved Presets -->
            <div class="collapsible-section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>💾 Saved Presets</span>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="section-content">
                    <div class="form-group" style="display:flex; gap:8px; align-items:center;">
                        <input id="preset-name-input" type="text" placeholder="Preset name (optional)" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px;" />
                        <button class="save-btn" onclick="savePresetAutoSlot()">Save Current</button>
                    </div>
                    <div id="preset-grid" class="preset-grid"></div>
                </div>
            </div>
        </div>
        <!-- Setup Tab -->
        <div id="setup-tab" class="tab-content">
            <!-- Oura Connection -->
            <div class="collapsible-section">
                <div class="section-header expanded" onclick="toggleSection(this)">
                    <span>🔗 Oura Ring Connection</span>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="section-content expanded">
                    <div class="form-group">
                        <button class="connect-btn disconnected" id="connect-btn" onclick="connectToOura()">Connect to Oura Ring</button>
                        <div class="connection-status" id="connection-status" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- Data Settings -->
            <div class="collapsible-section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>📊 Data Settings</span>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="section-content">
                    <div class="form-group">
                        <label for="refresh-frequency">Refresh Frequency (minutes)</label>
                        <input type="number" id="refresh-frequency" min="1" max="1440" value="30">
                    </div>
                </div>
            </div>

            <!-- Configuration -->
            <div class="collapsible-section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>⚙️ Configuration</span>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="section-content">
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="show-loading">
                            <label for="show-loading">Show Loading Screen</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug Tab -->
        <div id="debug-tab" class="tab-content">
            <!-- Debug Settings -->
            <div class="collapsible-section">
                <div class="section-header expanded" onclick="toggleSection(this)">
                    <span>🐛 Debug Settings</span>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="section-content expanded">
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="show-debug">
                            <label for="show-debug">Show Debug Information</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Support Development -->
            <div class="collapsible-section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>❤️ Support Development</span>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="section-content">
                    <div class="form-group">
                        <p style="margin: 0 0 12px 0; color: #666; line-height: 1.4;">
                            Enjoying this watchface? Consider supporting its development:
                        </p>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button onclick="window.open('https://ko-fi.com/arturojreal', '_blank')" 
                                    style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                                ☕ Buy me a coffee
                            </button>
                            <!-- <button onclick="window.open('https://github.com/arturojreal/pebble-oura-stats, '_blank')" 
                                    style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                                ⭐ Star on GitHub
                            </button> -->
                        </div>
                        <p style="margin: 12px 0 0 0; font-size: 12px; color: #999;">
                            Created by Arturo J. Real • Version 2.5.0
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Pebble color palette with names
        const colorPalette = [
            { name: 'Black', hex: '#000000' },
            { name: 'Oxford Blue', hex: '#002E5D' },
            { name: 'Duke Blue', hex: '#003F88' },
            { name: 'Blue', hex: '#0055FF' },
            { name: 'Dark Green', hex: '#005500' },
            { name: 'Midnight Green', hex: '#004953' },
            { name: 'Cobalt Blue', hex: '#0066FF' },
            { name: 'Blue Moon', hex: '#0077FF' },
            { name: 'Islamic Green', hex: '#009900' },
            { name: 'Jaeger Green', hex: '#00AA55' },
            { name: 'Tiffany Blue', hex: '#00AAAA' },
            { name: 'Vivid Cerulean', hex: '#00BBFF' },
            { name: 'Green', hex: '#00FF00' },
            { name: 'Malachite', hex: '#00FF55' },
            { name: 'Medium Spring Green', hex: '#00FFAA' },
            { name: 'Cyan', hex: '#00FFFF' },
            { name: 'Bulgarian Rose', hex: '#550000' },
            { name: 'Imperial Purple', hex: '#550055' },
            { name: 'Indigo', hex: '#5500AA' },
            { name: 'Electric Ultramarine', hex: '#5500FF' },
            { name: 'Army Green', hex: '#555500' },
            { name: 'Dark Gray', hex: '#555555' },
            { name: 'Liberty', hex: '#5555AA' },
            { name: 'Very Light Blue', hex: '#5555FF' },
            { name: 'Kelly Green', hex: '#55AA00' },
            { name: 'May Green', hex: '#55AA55' },
            { name: 'Cadet Blue', hex: '#55AAAA' },
            { name: 'Picton Blue', hex: '#55AAFF' },
            { name: 'Bright Green', hex: '#55FF00' },
            { name: 'Screamin Green', hex: '#55FF55' },
            { name: 'Medium Aquamarine', hex: '#55FFAA' },
            { name: 'Electric Blue', hex: '#55FFFF' },
            { name: 'Dark Candy Apple Red', hex: '#AA0000' },
            { name: 'Jazzberry Jam', hex: '#AA0055' },
            { name: 'Purple', hex: '#AA00AA' },
            { name: 'Vivid Violet', hex: '#AA00FF' },
            { name: 'Windsor Tan', hex: '#AA5500' },
            { name: 'Rose Vale', hex: '#AA5555' },
            { name: 'Purpureus', hex: '#AA55AA' },
            { name: 'Lavender Indigo', hex: '#AA55FF' },
            { name: 'Limerick', hex: '#AAAA00' },
            { name: 'Brass', hex: '#AAAA55' },
            { name: 'Light Gray', hex: '#AAAAAA' },
            { name: 'Baby Blue Eyes', hex: '#AAAAFF' },
            { name: 'Spring Bud', hex: '#AAFF00' },
            { name: 'Inchworm', hex: '#AAFF55' },
            { name: 'Mint Green', hex: '#AAFFAA' },
            { name: 'Celeste', hex: '#AAFFFF' },
            { name: 'Red', hex: '#FF0000' },
            { name: 'Folly', hex: '#FF0055' },
            { name: 'Fashion Magenta', hex: '#FF00AA' },
            { name: 'Magenta', hex: '#FF00FF' },
            { name: 'Orange', hex: '#FF5500' },
            { name: 'Sunset Orange', hex: '#FF5555' },
            { name: 'Brilliant Rose', hex: '#FF55AA' },
            { name: 'Shocking Pink', hex: '#FF55FF' },
            { name: 'Chrome Yellow', hex: '#FFAA00' },
            { name: 'Rajah', hex: '#FFAA55' },
            { name: 'Melon', hex: '#FFAAAA' },
            { name: 'Rich Brilliant Lavender', hex: '#FFAAFF' },
            { name: 'Yellow', hex: '#FFFF00' },
            { name: 'Icterine', hex: '#FFFF55' },
            { name: 'Pastel Yellow', hex: '#FFFFAA' },
            { name: 'White', hex: '#FFFFFF' }
        ];

        // Default settings object
        let defaultSettings = {
            show_seconds: false,
            compact_time: false,
            date_format: 0,
            // Default to Dark Mode
            theme_mode: 0,
            custom_color_index: 0,
            use_emoji: false,
            // Default colors for dark mode: Black background (index 0), white text (index 63)
            background_color: 0,
            time_color: 63,
            date_color: 63,
            readiness_color: 63,
            sleep_color: 63,
            heart_rate_color: 63,
            activity_color: 63,
            stress_color: 63,
            layout_rows: 1,
            layout_left: 0,
            layout_middle: 1,
            layout_right: 2,
            layout_row2_left: 3,
            layout_row2_right: 4,
            refresh_frequency: 30,
            show_debug: false,
            show_loading: false
        };

        // State management
        let currentTab = 'customize';
        let isDarkMode = false;
        let settings = {};
        let originalSettings = {};
        let hasUnsavedChanges = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Populate color selects first so selected values apply correctly
            populateColorDropdowns();
            loadSettings();
            restoreLastTab();
            updateThemeToggle();
            setupChangeDetection();
            updatePreview();
            // Render presets grid
            renderPresetsGrid();
            
            // Check for OAuth token in URL hash
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const accessToken = params.get('access_token');
            
            if (accessToken) {
                localStorage.setItem('oura_access_token', accessToken);
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            // Update connection state
            updateConnectionState();
        });

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            
            currentTab = tabName;
            localStorage.setItem('oura_last_tab', tabName);
        }

        // Section toggling
        function toggleSection(header) {
            const content = header.nextElementSibling;
            const isExpanded = header.classList.contains('expanded');
            
            if (isExpanded) {
                header.classList.remove('expanded');
                content.classList.remove('expanded');
            } else {
                header.classList.add('expanded');
                content.classList.add('expanded');
            }
        }

        // Presets management (up to 3)
        function getPresets() {
            try {
                const raw = localStorage.getItem('oura_presets');
                const arr = raw ? JSON.parse(raw) : [];
                return Array.isArray(arr) ? arr.slice(0,3) : [];
            } catch(e) { return []; }
        }
        function setPresets(presets) {
            localStorage.setItem('oura_presets', JSON.stringify((presets||[]).slice(0,3)));
        }
        function savePresetAutoSlot() {
            const nameInput = document.getElementById('preset-name-input');
            const name = (nameInput && nameInput.value.trim()) || `Preset ${new Date().toLocaleTimeString()}`;
            let presets = getPresets();
            // Find first empty slot or cap at 3
            if (presets.length < 3) {
                presets.push(createPresetObject(name));
            } else {
                // Overwrite oldest (index 0)
                presets[0] = createPresetObject(name);
            }
            setPresets(presets);
            renderPresetsGrid();
        }
        function createPresetObject(name) {
            // Use current normalized settings
            collectAllSettings();
            const snapshot = JSON.parse(JSON.stringify(settings));
            return { name, settings: snapshot, ts: Date.now() };
        }
        function renderPresetsGrid() {
            const grid = document.getElementById('preset-grid');
            if (!grid) return;
            const presets = getPresets();
            grid.innerHTML = '';
            // Ensure exactly 3 slots for UI
            for (let i=0;i<3;i++) {
                const card = document.createElement('div');
                card.className = 'preset-card';
                const preset = presets[i];
                if (preset) {
                    const titleRow = document.createElement('div');
                    titleRow.className = 'preset-title-row';
                    const title = document.createElement('div');
                    title.className = 'preset-title';
                    title.textContent = preset.name || `Preset ${i+1}`;
                    const renameBtn = document.createElement('button');
                    renameBtn.textContent = 'Rename';
                    renameBtn.onclick = () => renamePreset(i);
                    titleRow.appendChild(title);
                    titleRow.appendChild(renameBtn);
                    const thumbWrap = document.createElement('div');
                    thumbWrap.className = 'preset-thumb';
                    const previewEl = buildMiniPreviewElement();
                    thumbWrap.appendChild(previewEl);
                    const actions = document.createElement('div');
                    actions.className = 'preset-actions';
                    const loadBtn = document.createElement('button');
                    loadBtn.textContent = 'Load';
                    loadBtn.onclick = () => loadPreset(i);
                    const replaceBtn = document.createElement('button');
                    replaceBtn.textContent = 'Replace';
                    replaceBtn.onclick = () => replacePreset(i);
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.onclick = () => deletePreset(i);
                    actions.appendChild(loadBtn);
                    actions.appendChild(replaceBtn);
                    actions.appendChild(deleteBtn);
                    card.appendChild(titleRow);
                    card.appendChild(thumbWrap);
                    card.appendChild(actions);
                    grid.appendChild(card);
                    // Render mini preview with stored settings
                    renderMiniPreview(previewEl, preset.settings);
                } else {
                    const title = document.createElement('div');
                    title.className = 'preset-title';
                    title.textContent = `Empty Slot ${i+1}`;
                    const thumbWrap = document.createElement('div');
                    thumbWrap.className = 'preset-thumb';
                    const previewEl = buildMiniPreviewElement();
                    thumbWrap.appendChild(previewEl);
                    const actions = document.createElement('div');
                    actions.className = 'preset-actions';
                    const saveHereBtn = document.createElement('button');
                    saveHereBtn.textContent = 'Save here';
                    saveHereBtn.onclick = () => savePresetToSlot(i);
                    actions.appendChild(saveHereBtn);
                    card.appendChild(title);
                    card.appendChild(thumbWrap);
                    card.appendChild(actions);
                    grid.appendChild(card);
                    // Render mini preview of current settings to illustrate
                    renderMiniPreview(previewEl, settings);
                }
            }
        }
        function savePresetToSlot(i) {
            const nameInput = document.getElementById('preset-name-input');
            const name = (nameInput && nameInput.value.trim()) || `Preset ${i+1}`;
            const presets = getPresets();
            presets[i] = createPresetObject(name);
            setPresets(presets);
            renderPresetsGrid();
        }
        function replacePreset(i) { savePresetToSlot(i); }
        function renamePreset(i) {
            const presets = getPresets();
            if (!presets[i]) return;
            const newName = prompt('Rename preset:', presets[i].name || `Preset ${i+1}`);
            if (newName && newName.trim()) {
                presets[i].name = newName.trim();
                setPresets(presets);
                renderPresetsGrid();
            }
        }
        function deletePreset(i) {
            const presets = getPresets();
            presets.splice(i,1);
            setPresets(presets);
            renderPresetsGrid();
        }
        function loadPreset(i) {
            const presets = getPresets();
            const preset = presets[i];
            if (!preset) return;
            settings = { ...defaultSettings, ...preset.settings };
            normalizeSettings();
            applySettingsToUI();
            updatePreview();
            detectChanges();
            // Bring user to preview
            const previewSection = document.querySelector('#customize-tab .collapsible-section:nth-of-type(2) .section-header');
            if (previewSection && !previewSection.classList.contains('expanded')) previewSection.click();
        }
        function buildMiniPreviewElement() {
            const wrap = document.createElement('div');
            wrap.className = 'watchface-preview';
            wrap.style.width = '120px';
            wrap.style.height = '146px';
            // time
            const t = document.createElement('div'); t.className = 'preview-time'; t.textContent = '10:09';
            const d = document.createElement('div'); d.className = 'preview-date'; d.textContent = 'Aug 17';
            const comps = document.createElement('div'); comps.className = 'preview-complications';
            const row1 = document.createElement('div'); row1.className = 'preview-row'; row1.id = '';
            const mk = (id, v, l) => { const c = document.createElement('div'); c.className = 'preview-complication'; const vv = document.createElement('div'); vv.className = 'preview-value'; vv.id = id+'-value'; vv.textContent = v; const ll = document.createElement('div'); ll.className = 'preview-label'; ll.id = id+'-label'; ll.textContent = l; c.appendChild(vv); c.appendChild(ll); return c; };
            row1.appendChild(mk('mini-rdy','74','RDY'));
            row1.appendChild(mk('mini-slp','71','SLP'));
            row1.appendChild(mk('mini-hr','68','HR'));
            const row2 = document.createElement('div'); row2.className = 'preview-row'; row2.style.display = 'none';
            row2.appendChild(mk('mini-act','85','ACT'));
            row2.appendChild(mk('mini-str','2h','STR'));
            comps.appendChild(row1); comps.appendChild(row2);
            wrap.appendChild(t); wrap.appendChild(d); wrap.appendChild(comps);
            return wrap;
        }
        function renderMiniPreview(container, presetSettings) {
            if (!container) return;
            const s = { ...defaultSettings, ...presetSettings };
            // Colors
            const bg = getColorHexByIndex(s.background_color ?? 0, 0);
            const timeC = ensureContrast(getColorHexByIndex(s.time_color ?? 63, 63), bg);
            const dateC = ensureContrast(getColorHexByIndex(s.date_color ?? 63, 63), bg);
            container.style.backgroundColor = bg;
            const t = container.querySelector('.preview-time'); if (t) t.style.color = timeC;
            const d = container.querySelector('.preview-date'); if (d) d.style.color = dateC;
            // Layout rows
            const isDouble = s.layout_rows === 2 || s.layout_rows === '2';
            const rows = container.querySelectorAll('.preview-row');
            rows[0].className = `preview-row ${isDouble ? 'dual-row' : 'single-row'}`;
            rows[1].className = 'preview-row dual-row';
            rows[1].style.display = isDouble ? 'flex' : 'none';
            // Labels and values
            const measurements = ['readiness', 'sleep', 'heart_rate', 'activity', 'stress'];
            const sampleData = { readiness: 74, sleep: 71, heart_rate: 68, activity: 85, stress: '2h' };
            const emojiLabels = { readiness: '🎯', sleep: '😴', heart_rate: '❤️', activity: '🔥', stress: '😰' };
            const textLabels = { readiness: 'RDY', sleep: 'SLP', heart_rate: 'HR', activity: 'ACT', stress: 'STR' };
            const layoutPositions = [ parseInt(s.layout_left||0), parseInt(s.layout_middle||1), parseInt(s.layout_right||2) ];
            const row2Positions = [ parseInt(s.layout_row2_left||3), parseInt(s.layout_row2_right||4) ];
            const idsRow1 = ['mini-rdy','mini-slp','mini-hr'];
            idsRow1.forEach((id, idx) => {
                const meas = measurements[ layoutPositions[idx] ];
                const valEl = container.querySelector(`#${id}-value`);
                const labEl = container.querySelector(`#${id}-label`);
                if (valEl && labEl) {
                    valEl.textContent = sampleData[meas];
                    const label = s.use_emoji ? emojiLabels[meas] : textLabels[meas];
                    labEl.textContent = label;
                    labEl.className = `preview-label ${s.use_emoji ? 'emoji' : ''}`;
                    const colorKey = (meas + '_color');
                    const c = ensureContrast(getColorHexByIndex(s[colorKey] ?? 63, 63), bg);
                    valEl.style.color = c; labEl.style.color = c;
                }
            });
            if (isDouble) {
                const idsRow2 = ['mini-act','mini-str'];
                idsRow2.forEach((id, idx) => {
                    const meas = measurements[ row2Positions[idx] ];
                    const valEl = container.querySelector(`#${id}-value`);
                    const labEl = container.querySelector(`#${id}-label`);
                    if (valEl && labEl) {
                        valEl.textContent = sampleData[meas];
                        const label = s.use_emoji ? emojiLabels[meas] : textLabels[meas];
                        labEl.textContent = label;
                        labEl.className = `preview-label ${s.use_emoji ? 'emoji' : ''}`;
                        const colorKey = (meas + '_color');
                        const c = ensureContrast(getColorHexByIndex(s[colorKey] ?? 63, 63), bg);
                        valEl.style.color = c; labEl.style.color = c;
                    }
                });
            }
            // Date sample formatting similar to main preview
            const dateEl = container.querySelector('.preview-date');
            if (dateEl) {
                const now = new Date();
                const dateFormats = [
                    () => `${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}-${now.getFullYear()}`,
                    () => `${now.getDate().toString().padStart(2,'0')}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getFullYear()}`,
                    () => now.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }),
                    () => now.toLocaleDateString('en-US', { day: 'numeric', month: 'long', year: 'numeric' }),
                    () => now.toLocaleDateString('en-US', { month: 'long', day: 'numeric' }),
                    () => now.toLocaleDateString('en-US', { day: 'numeric', month: 'long' }),
                    () => now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
                    () => now.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' }),
                    () => now.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                    () => now.toLocaleDateString('en-US', { day: 'numeric', month: 'short' }),
                    () => now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }),
                    () => now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }),
                    () => `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}`
                ];
                const idx = parseInt(s.date_format || 0);
                dateEl.textContent = dateFormats[idx] ? dateFormats[idx]() : dateFormats[0]();
            }
        }

        // Theme toggle
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            localStorage.setItem('oura_theme', isDarkMode ? 'dark' : 'light');
        }

        function updateThemeToggle() {
            const savedTheme = localStorage.getItem('oura_theme');
            if (savedTheme === 'dark' || !savedTheme) {
                // Default config page theme to dark if none saved
                isDarkMode = true;
                document.body.classList.add('dark-mode');
                if (!savedTheme) localStorage.setItem('oura_theme', 'dark');
            }
        }

        // Color picker dropdowns with visual swatches
        function populateColorDropdowns() {
            const colorSelects = [
                'background-color', 'time-color', 'date-color', 'readiness-color',
                'sleep-color', 'heart-rate-color', 'activity-color', 'stress-color'
            ];
            
            colorSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '';
                    colorPalette.forEach((color, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = `⬤ ${color.name}`;
                        option.style.backgroundColor = color.hex;
                        option.style.color = isLightColor(color.hex) ? '#000' : '#fff';
                        option.style.fontWeight = 'bold';
                        option.style.padding = '4px 8px';
                        select.appendChild(option);
                    });
                    
                    // Style the select element itself
                    select.style.fontWeight = 'bold';
                    select.addEventListener('change', function() {
                        const selectedIndex = parseInt(this.value);
                        const selectedColor = colorPalette[selectedIndex];
                        this.style.backgroundColor = selectedColor.hex;
                        this.style.color = isLightColor(selectedColor.hex) ? '#000' : '#fff';
                    });
                }
            });
        }
        
        // Check if color is light for contrast
        function isLightColor(hex) {
            const r = parseInt(hex.substr(1, 2), 16);
            const g = parseInt(hex.substr(3, 2), 16);
            const b = parseInt(hex.substr(5, 2), 16);
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness > 128;
        }

        function selectColor(index, swatch) {
            document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
            swatch.classList.add('selected');
            settings.custom_color_index = index;
            
            // Send color preview to watchface
            sendColorPreview(index);
            
            // Trigger change detection
            detectChanges();
        }

        function toggleColorPicker() {
            const themeMode = document.getElementById('theme-mode').value;
            const colorSection = document.getElementById('color-picker');
            if (colorSection) {
                colorSection.classList.toggle('visible', themeMode === '2');
            }
            updatePreview();
        }

        // Theme mode change handler - apply sensible defaults per mode
        function onThemeModeChange() {
            const themeMode = document.getElementById('theme-mode').value;
            if (themeMode === '0') {
                applyThemeDefaults('dark');
            } else if (themeMode === '1') {
                applyThemeDefaults('light');
            }
            toggleColorPicker();
            detectChanges();
        }

        function toggleRow2Options() {
            const rows = document.getElementById('layout-rows').value;
            const row2Options = document.getElementById('row2-options');
            const previewRow2 = document.getElementById('preview-row2');
            
            row2Options.classList.toggle('hidden', rows !== '2');
            if (previewRow2) {
                previewRow2.style.display = rows === '2' ? 'flex' : 'none';
            }
            updatePreview();
        }

        // Settings management
        function loadSettings() {
            // Load from localStorage or use defaults
            const saved = localStorage.getItem('oura_settings');
            if (saved) {
                settings = { ...defaultSettings, ...JSON.parse(saved) };
            } else {
                settings = { ...defaultSettings };
            }
            normalizeSettings();
            originalSettings = JSON.parse(JSON.stringify(settings)); // Deep copy
            applySettingsToUI();
        }

        function applySettingsToUI() {
            // Apply all settings to form elements
            Object.keys(settings).forEach(key => {
                const element = document.getElementById(key.replace(/_/g, '-'));
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = settings[key];
                    } else {
                        element.value = settings[key];
                    }
                }
            });
            
            // Update dependent UI elements
            toggleColorPicker();
            toggleRow2Options();
            // Ensure color selects visually reflect the chosen values
            styleAllColorSelects();
            updatePreview();
        }

        function styleAllColorSelects() {
            const ids = ['background-color','time-color','date-color','readiness-color','sleep-color','heart-rate-color','activity-color','stress-color'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                const idx = parseInt(el.value);
                if (isNaN(idx) || idx < 0 || idx >= colorPalette.length) return;
                const hex = colorPalette[idx].hex;
                el.style.backgroundColor = hex;
                el.style.color = isLightColor(hex) ? '#000' : '#fff';
                el.style.fontWeight = 'bold';
            });
        }

        function restoreLastTab() {
            const lastTab = localStorage.getItem('oura_last_tab');
            if (lastTab && ['customize', 'setup', 'debug'].includes(lastTab)) {
                const tabButton = document.querySelector(`[onclick="switchTab('${lastTab}')"]`);
                if (tabButton) {
                    tabButton.click();
                }
            }
        }

        // Save changes locally
        function saveChanges() {
            collectAllSettings();
            localStorage.setItem('oura_settings', JSON.stringify(settings));
            originalSettings = JSON.parse(JSON.stringify(settings)); // Update baseline
            hasUnsavedChanges = false;
            updateSaveButton();
        }
        
        // Close config using proper Pebble SDK pattern
        function closeConfig() {
            try {
                collectAllSettings();
                console.log('Closing config and sending settings to Pebble:', settings);
                // Persist settings locally so the config page reflects choices next time
                localStorage.setItem('oura_settings', JSON.stringify(settings));
                
                // Get the return_to URL parameter (provided by Pebble)
                function getQueryParam(variable, defaultValue) {
                    var query = location.search.substring(1);
                    var vars = query.split('&');
                    for (var i = 0; i < vars.length; i++) {
                        var pair = vars[i].split('=');
                        if (pair[0] === variable) {
                            return decodeURIComponent(pair[1]);
                        }
                    }
                    return defaultValue || false;
                }
                
                // Use proper Pebble SDK pattern: redirect to return_to URL with encoded data
                var return_to = getQueryParam('return_to', 'pebblejs://close#');
                var location_url = return_to + encodeURIComponent(JSON.stringify(settings));
                
                console.log('Redirecting to:', location_url);
                document.location = location_url;
                
            } catch (error) {
                console.error('Error in closeConfig:', error);
                alert('Settings saved! You can now close this page.');
            }
        }

        function collectAllSettings() {
            // Collect all form values
            const formElements = document.querySelectorAll('input, select');
            formElements.forEach(element => {
                const key = element.id.replace(/-/g, '_');
                if (element.type === 'checkbox') {
                    settings[key] = element.checked;
                } else if (element.type === 'number') {
                    settings[key] = parseInt(element.value);
                } else {
                    settings[key] = element.value;
                }
            });
            normalizeSettings();
        }

        // Apply default color sets for theme modes without touching other settings
        function applyThemeDefaults(mode) {
            if (!settings) return;
            if (mode === 'dark') {
                settings.theme_mode = 0;
                settings.background_color = 0; // Black
                settings.time_color = 63;      // White
                settings.date_color = 63;
                settings.readiness_color = 63;
                settings.sleep_color = 63;
                settings.heart_rate_color = 63;
                settings.activity_color = 63;
                settings.stress_color = 63;
            } else if (mode === 'light') {
                settings.theme_mode = 1;
                settings.background_color = 63; // White
                settings.time_color = 0;        // Black
                settings.date_color = 0;
                settings.readiness_color = 0;
                settings.sleep_color = 0;
                settings.heart_rate_color = 0;
                settings.activity_color = 0;
                settings.stress_color = 0;
            }
            normalizeSettings();
            // Push updates to UI controls
            applySettingsToUI();
        }

        // Reset all settings to defaults (dark mode baseline)
        function resetToDefaults() {
            settings = JSON.parse(JSON.stringify(defaultSettings));
            normalizeSettings();
            applySettingsToUI();
            hasUnsavedChanges = JSON.stringify(settings) !== JSON.stringify(originalSettings);
            updateSaveButton();
            updatePreview();
        }

        // Coerce numeric fields to integers and clamp ranges
        function normalizeSettings() {
            const intKeys = [
              'theme_mode','custom_color_index','background_color','time_color','date_color',
              'readiness_color','sleep_color','heart_rate_color','activity_color','stress_color',
              'layout_rows','layout_left','layout_middle','layout_right','layout_row2_left','layout_row2_right',
              'date_format','refresh_frequency'
            ];
            intKeys.forEach(k => {
                if (settings.hasOwnProperty(k)) {
                    const n = parseInt(settings[k]);
                    if (!isNaN(n)) settings[k] = n;
                }
            });
            // Clamp color indices
            ['background_color','time_color','date_color','readiness_color','sleep_color','heart_rate_color','activity_color','stress_color'].forEach(k => {
                if (typeof settings[k] === 'number') {
                    if (settings[k] < 0) settings[k] = 0;
                    if (settings[k] >= colorPalette.length) settings[k] = colorPalette.length - 1;
                }
            });
        }
        
        // Change detection
        function setupChangeDetection() {
            const formElements = document.querySelectorAll('input, select');
            formElements.forEach(element => {
                element.addEventListener('change', detectChanges);
                element.addEventListener('input', detectChanges);
            });
        }
        
        function detectChanges() {
            collectAllSettings();
            hasUnsavedChanges = JSON.stringify(settings) !== JSON.stringify(originalSettings);
            updateSaveButton();
            updatePreview();
        }
        
        // Helper: safely get a color hex from palette by index with clamping
        function getColorHexByIndex(index, fallbackIndex) {
            let idx = Number(index);
            if (!Number.isInteger(idx)) idx = fallbackIndex;
            if (idx < 0) idx = 0;
            if (idx >= colorPalette.length) idx = colorPalette.length - 1;
            return colorPalette[idx].hex;
        }

        // Live preview update function
        function updatePreview() {
            if (!settings) return;
            
            const preview = document.getElementById('watchface-preview');
            const timeEl = document.getElementById('preview-time');
            const dateEl = document.getElementById('preview-date');
            
            // Get current colors
            const bgColor = getColorHexByIndex(settings.background_color ?? 0, 0);
            const timeColor = getColorHexByIndex(settings.time_color ?? 63, 63);
            const dateColor = getColorHexByIndex(settings.date_color ?? 63, 63);
            
            // Apply colors to preview with contrast safeguard
            if (preview) preview.style.backgroundColor = bgColor;
            if (timeEl) timeEl.style.color = ensureContrast(timeColor, bgColor);
            if (dateEl) dateEl.style.color = ensureContrast(dateColor, bgColor);
            
            // Update time display
            if (timeEl) {
                const now = new Date();
                let timeStr = now.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                });
                if (settings.show_seconds) {
                    timeStr = now.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        second: '2-digit',
                        hour12: false 
                    });
                }
                timeEl.textContent = timeStr;
            }
            
            // Update date display
            if (dateEl) {
                const now = new Date();
                const dateFormats = [
                    () => `${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}-${now.getFullYear()}`,
                    () => `${now.getDate().toString().padStart(2,'0')}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getFullYear()}`,
                    () => now.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }),
                    () => now.toLocaleDateString('en-US', { day: 'numeric', month: 'long', year: 'numeric' }),
                    () => now.toLocaleDateString('en-US', { month: 'long', day: 'numeric' }),
                    () => now.toLocaleDateString('en-US', { day: 'numeric', month: 'long' }),
                    () => now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
                    () => now.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' }),
                    () => now.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                    () => now.toLocaleDateString('en-US', { day: 'numeric', month: 'short' }),
                    () => now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }),
                    () => now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }),
                    () => `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}`
                ];
                const formatIndex = parseInt(settings.date_format || 0);
                dateEl.textContent = dateFormats[formatIndex] ? dateFormats[formatIndex]() : dateFormats[0]();
            }
            
            // Update complications
            updateComplications();
        }
        
        function updateComplications() {
            const measurements = ['readiness', 'sleep', 'heart_rate', 'activity', 'stress'];
            const sampleData = { readiness: 74, sleep: 71, heart_rate: 68, activity: 85, stress: '2h' };
            const emojiLabels = { readiness: '🎯', sleep: '😴', heart_rate: '❤️', activity: '🔥', stress: '😰' };
            const textLabels = { readiness: 'RDY', sleep: 'SLP', heart_rate: 'HR', activity: 'ACT', stress: 'STR' };
            
            // Get layout configuration
            const layoutPositions = [
                parseInt(settings.layout_left || 0),
                parseInt(settings.layout_middle || 1), 
                parseInt(settings.layout_right || 2)
            ];
            
            const row2Positions = [
                parseInt(settings.layout_row2_left || 3),
                parseInt(settings.layout_row2_right || 4)
            ];
            
            const isDoubleRow = settings.layout_rows === 2 || settings.layout_rows === '2';
            
            // Update row classes for proper sizing
            const row1 = document.getElementById('preview-row1');
            const row2 = document.getElementById('preview-row2');
            
            if (row1) {
                row1.className = `preview-row ${isDoubleRow ? 'dual-row' : 'single-row'}`;
            }
            if (row2) {
                row2.className = 'preview-row dual-row';
                row2.style.display = isDoubleRow ? 'flex' : 'none';
            }
            
            // Update row 1 complications
            ['rdy', 'slp', 'hr'].forEach((id, index) => {
                const measurementIndex = layoutPositions[index];
                const measurement = measurements[measurementIndex];
                const valueEl = document.getElementById(`preview-${id}-value`);
                const labelEl = document.getElementById(`preview-${id}-label`);
                
                if (valueEl && labelEl) {
                    valueEl.textContent = sampleData[measurement];
                    const labelText = settings.use_emoji ? emojiLabels[measurement] : textLabels[measurement];
                    labelEl.textContent = labelText;
                    
                    // Apply emoji class for proper sizing
                    labelEl.className = `preview-label ${settings.use_emoji ? 'emoji' : ''}`;
                    
                    // Apply colors with contrast checking
                    const colorKey = measurement.replace('_', '_') + '_color';
                    const color = getColorHexByIndex(settings[colorKey] ?? 63, 63);
                    const bgColor = getColorHexByIndex(settings.background_color ?? 0, 0);
                    
                    // Ensure sufficient contrast
                    const finalColor = ensureContrast(color, bgColor);
                    valueEl.style.color = finalColor;
                    labelEl.style.color = finalColor;
                }
            });
            
            // Update row 2 complications if visible
            if (isDoubleRow) {
                ['act', 'str'].forEach((id, index) => {
                    const measurementIndex = row2Positions[index];
                    const measurement = measurements[measurementIndex];
                    const valueEl = document.getElementById(`preview-${id}-value`);
                    const labelEl = document.getElementById(`preview-${id}-label`);
                    
                    if (valueEl && labelEl) {
                        valueEl.textContent = sampleData[measurement];
                        const labelText = settings.use_emoji ? emojiLabels[measurement] : textLabels[measurement];
                        labelEl.textContent = labelText;
                        
                        // Apply emoji class for proper sizing
                        labelEl.className = `preview-label ${settings.use_emoji ? 'emoji' : ''}`;
                        
                        // Apply colors with contrast checking
                        const colorKey = measurement.replace('_', '_') + '_color';
                        const color = getColorHexByIndex(settings[colorKey] ?? 63, 63);
                        const bgColor = getColorHexByIndex(settings.background_color ?? 0, 0);
                        
                        // Ensure sufficient contrast
                        const finalColor = ensureContrast(color, bgColor);
                        valueEl.style.color = finalColor;
                        labelEl.style.color = finalColor;
                    }
                });
            }
        }
        
        // Ensure sufficient contrast between text and background colors
        function ensureContrast(textColor, bgColor) {
            const contrast = getContrastRatio(textColor, bgColor);
            
            // If contrast is too low, use white or black for better readability
            if (contrast < 3.0) {
                const bgLuminance = getLuminance(bgColor);
                return bgLuminance > 0.5 ? '#000000' : '#FFFFFF';
            }
            
            return textColor;
        }
        
        // Calculate contrast ratio between two colors
        function getContrastRatio(color1, color2) {
            const lum1 = getLuminance(color1);
            const lum2 = getLuminance(color2);
            const brightest = Math.max(lum1, lum2);
            const darkest = Math.min(lum1, lum2);
            return (brightest + 0.05) / (darkest + 0.05);
        }
        
        // Calculate relative luminance of a color
        function getLuminance(hex) {
            const rgb = hexToRgb(hex);
            const rsRGB = rgb.r / 255;
            const gsRGB = rgb.g / 255;
            const bsRGB = rgb.b / 255;
            
            const r = rsRGB <= 0.03928 ? rsRGB / 12.92 : Math.pow((rsRGB + 0.055) / 1.055, 2.4);
            const g = gsRGB <= 0.03928 ? gsRGB / 12.92 : Math.pow((gsRGB + 0.055) / 1.055, 2.4);
            const b = bsRGB <= 0.03928 ? bsRGB / 12.92 : Math.pow((bsRGB + 0.055) / 1.055, 2.4);
            
            return 0.2126 * r + 0.7152 * g + 0.0722 * b;
        }
        
        // Convert hex color to RGB
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }
        
        function updateSaveButton() {
            const saveBtn = document.getElementById('save-btn');
            if (hasUnsavedChanges) {
                saveBtn.disabled = false;
                saveBtn.classList.add('has-changes');
                saveBtn.textContent = 'Save*';
            } else {
                saveBtn.disabled = true;
                saveBtn.classList.remove('has-changes');
                saveBtn.textContent = 'Save';
            }
        }

        // Connection state management
        function updateConnectionState() {
            const connectBtn = document.getElementById('connect-btn');
            const statusDiv = document.getElementById('connection-status');
            const token = localStorage.getItem('oura_access_token');
            
            if (token) {
                // Check if token is valid by making a test request
                fetch('https://peppy-pothos-093b81.netlify.app/.netlify/functions/oura-proxy?endpoint=personal_info', {
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                .then(response => {
                    if (response.ok) {
                        // Connected state
                        connectBtn.className = 'connect-btn connected';
                        connectBtn.textContent = '✅ Connected to Oura Ring';
                        statusDiv.className = 'connection-status connected';
                        statusDiv.textContent = `✅ Token stored. Review diagnostics below, then tap "Send to Pebble" when ready.`;
                        statusDiv.style.display = 'block';
                    } else {
                        // Error state
                        connectBtn.className = 'connect-btn error';
                        connectBtn.textContent = '❌ Connection Error - Retry';
                        statusDiv.className = 'connection-status error';
                        statusDiv.textContent = 'Token expired or invalid. Please reconnect.';
                        statusDiv.style.display = 'block';
                    }
                })
                .catch(() => {
                    // Error state
                    connectBtn.className = 'connect-btn error';
                    connectBtn.textContent = '❌ Connection Error - Retry';
                    statusDiv.className = 'connection-status error';
                    statusDiv.textContent = 'Unable to verify connection. Please try again.';
                    statusDiv.style.display = 'block';
                });
            } else {
                // Disconnected state
                connectBtn.className = 'connect-btn disconnected';
                connectBtn.textContent = 'Connect to Oura Ring';
                statusDiv.style.display = 'none';
            }
        }
        
        

        // Pebble communication
        function sendToPebble() {
            console.log('sendToPebble called with settings:', settings);
            
            if (typeof Pebble !== 'undefined') {
                console.log('Pebble object found, sending message and closing...');
                Pebble.sendAppMessage(settings);
                Pebble.close();
            } else {
                console.log('No Pebble object found, running in browser mode');
                // Don't try to close here - let closeConfig handle it
            }
        }

        function sendColorPreview(colorIndex) {
            if (typeof Pebble !== 'undefined') {
                Pebble.sendAppMessage({
                    custom_color_index: colorIndex,
                    theme_mode: 2 // Force custom color mode for preview
                });
            }
        }

        function connectToOura() {
            // Save current settings before redirect
            collectAllSettings();
            localStorage.setItem('oura_settings', JSON.stringify(settings));
            
            const CLIENT_ID = 'TGDTXUBGWULVNKSC';
            const REDIRECT_URI = 'https://peppy-pothos-093b81.netlify.app/pebble-static-config.html';
            const SCOPE = 'email personal heartrate workout tag session daily';
            const authUrl = `https://cloud.ouraring.com/oauth/authorize?response_type=token&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPE)}`;
            window.location.href = authUrl;
        }

        // Check for OAuth token on page load
        window.addEventListener('load', function() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const accessToken = params.get('access_token');
            
            if (accessToken) {
                // Load existing settings first
                const saved = localStorage.getItem('oura_settings');
                if (saved) {
                    settings = JSON.parse(saved);
                }
                
                // Add the access token
                settings.access_token = accessToken;
                localStorage.setItem('oura_settings', JSON.stringify(settings));
                originalSettings = JSON.parse(JSON.stringify(settings)); // Update baseline
                
                // Clear the hash from URL
                window.location.hash = '';
                alert('Successfully connected to Oura Ring!');
                
                // Update UI to reflect the connection
                applySettingsToUI();
                updateSaveButton();
            }
        });
    </script>
</body>
</html>
