<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oura Stats - Pebble Configuration</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- FORCE CACHE INVALIDATION: 2025-08-13-14:39 - COMPLETE REBUILD -->
    <script>
        // Cache buster - force CDN to serve fresh content
        console.log('üîÑ Config page loaded at:', new Date().toISOString());
        console.log('üìã Cache bust timestamp: 2025-08-13-14:39');
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 20px;
            max-width: 400px;
            margin: 0 auto;
            background: #f5f5f5;
            line-height: 1.4;
        }
        .container {
            background: white;
            padding: 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            overflow: hidden;
        }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.2s ease;
        }
        
        .tab-button.active {
            color: #007bff;
            background: white;
            border-bottom: 2px solid #007bff;
        }
        
        .tab-button:hover {
            background: #e9ecef;
        }
        
        .tab-button.active:hover {
            background: white;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
            padding: 25px;
        }
        
        .tab-content.active {
            display: block;
        }
        h1 {
            color: #333;
            margin-bottom: 15px;
            font-size: 22px;
        }
        .status {
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: 500;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        .connect-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            margin: 15px 0;
            border: none;
            cursor: pointer;
        }
        .connect-btn:hover {
            background: #0056b3;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .info {
            background: #e7f3ff;
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 14px;
            color: #0c5460;
        }
        .token-info {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
        }
        .debug-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 12px;
            border-left: 4px solid #007bff;
        }
        .section-box {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            margin: 12px 0;
        }
        .section-title {
            font-weight: 600;
            color: #333;
            margin: 0 0 8px 0;
            font-size: 13px;
        }
        .kv {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 6px 10px;
            font-size: 12px;
            margin-top: 10px;
        }
        .kv div:nth-child(odd) { color: #555; }
        .kv div:nth-child(even) {
            word-break: break-word;
        }
        .debug-log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            max-height: 160px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
            margin: 10px 0;
        }
        .test-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            margin: 5px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #218838;
        }
        .warn { color: #b45400; }
        .ok { color: #1f7a1f; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ko-fi Support CTA -->
        <div style="background: linear-gradient(135deg, #29abe0, #00d4aa); color: white; padding: 15px; text-align: center; font-weight: bold; border-radius: 8px 8px 0 0;">
            <div style="font-size: 16px; margin-bottom: 8px;">‚òï Want to support this development?</div>
            <a href="https://ko-fi.com/arturojreal" target="_blank" style="text-decoration: none; color: inherit; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; display: inline-block; font-size: 14px; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                üíù Buy me a coffee!
            </a>
        </div>
        
        <!-- Construction Banner (Modularized - can be easily commented out) -->
        <!-- CONSTRUCTION_BANNER_START -->
        <div style="background: linear-gradient(135deg, #ff6b6b, #ffa726); color: white; padding: 15px; text-align: center; font-weight: bold;">
            <div style="font-size: 18px; margin-bottom: 5px;">üöß Configuration Pages Under Construction</div>
            <div style="font-size: 14px; opacity: 0.9;" id="construction-date">Loading date... - Some features may experience issues, delays, or unexpected behavior</div>
        </div>
        <!-- CONSTRUCTION_BANNER_END -->
        
        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-button active" onclick="switchTab('setup')">‚öôÔ∏è Setup</button>
            <button class="tab-button" onclick="switchTab('customization')">üé® Customization</button>
        </div>
        
        <!-- Setup Tab -->
        <div id="setup-tab" class="tab-content active">
            <h1>üèÉ‚Äç‚ôÇÔ∏è Oura Stats Setup</h1>
            
            <!-- Debug Toggle (moved to top for better UX) -->
            <div id="debug-toggle-section" style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                <label style="display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; font-size: 14px;">
                    <input type="checkbox" id="show-debug" onchange="toggleDebugVisibility()" style="transform: scale(1.2);">
                    <span>Show debug information</span>
                </label>
            </div>
            
            <div id="status" class="status disconnected">
            Checking connection...
        </div>

        <div id="connect-section">
            <button id="connect-btn" class="connect-btn">
                Connect to Oura Ring
            </button>
            
            <div class="info">
                <strong>How it works:</strong><br>
                Tap "Connect" ‚Üí Login to Oura ‚Üí Return here automatically
            </div>
        </div>

        <div id="connected-section" style="display: none;">
            <div class="info">
                ‚úÖ Token stored. Review diagnostics below, then tap "Send to Pebble" when ready.
            </div>
            
            <div class="token-info" id="token-display"></div>
            
            <button onclick="sendAndClose()" class="connect-btn">Send to Pebble (Close)</button>
            <button onclick="closeWebview()" class="connect-btn btn-secondary">Close (Don‚Äôt Send)</button>
            <button onclick="clearSettings()" class="connect-btn btn-danger">Clear Settings</button>
        </div>

        <div class="debug-section" style="display: none;">
            <h3>üîç Debug Information</h3>

            <div class="section-box">
                <div class="section-title">Developer Status</div>
                <div class="kv" id="dev-kv"></div>
            </div>

            <div class="section-box">
                <div class="section-title">Live Log</div>
                <div class="debug-log" id="debug-log">Debug information will appear here...</div>
                <div>
                    <button onclick="testOuraAPI()" class="test-button">Test Oura API</button>
                    <button onclick="checkStoredData()" class="test-button">Check Stored Data</button>
                    <button onclick="resendToPebble()" class="test-button">Resend to Pebble</button>
                    <button onclick="copyLog()" class="test-button">Copy Log</button>
                    <button onclick="clearDebugLog()" class="test-button">Clear Log</button>
                </div>
                <div id="copy-status" style="font-size:11px;color:#555;margin-top:6px;display:none;">Copied!</div>
            </div>

            <div class="section-box">
                <div class="section-title">Token Details</div>
                <div id="token-details"></div>
            </div>

            <div class="section-box">
                <div class="section-title">API Test Results</div>
                <div style="margin-bottom:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                    <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:#333;">
                        <input type="checkbox" id="use-proxy-toggle" />
                        Use Proxy for Test
                    </label>
                    <span style="font-size:11px;color:#666;">Direct API calls often fail inside the Pebble webview due to CORS/TLS; enable Proxy.</span>
                </div>
                <div id="api-test-results"></div>
            </div>
        </div>
        
        </div> <!-- End Setup Tab -->
        
        <!-- Customization Tab -->
        <div id="customization-tab" class="tab-content">

            
            <h1>üéõÔ∏è Customization</h1>
            
            <!-- Layout Configuration -->
            <div class="section-box" style="margin: 20px 0;">
                <div class="section-title">üìê Layout Configuration</div>
                <p style="font-size: 14px; color: #666; margin: 10px 0;">Choose how many rows of measurements to display on your watchface.</p>
                
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Number of Rows:</label>
                    <select id="layout-rows" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="1" selected>1 Row (3 measurements, larger emojis)</option>
                        <option value="2">2 Rows (up to 6 measurements, smaller emojis)</option>
                    </select>
                    <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">1 row shows larger emojis, 2 rows allows more measurements</p>
                </div>
            </div>

            <!-- Measurement Organization -->
            <div class="section-box" style="margin: 20px 0;">
                <div class="section-title">üìä Measurement Organization</div>
                <p style="font-size: 14px; color: #666; margin: 10px 0;">Choose which measurement appears in each position on your watchface.</p>
                
                <!-- Visual Layout Preview -->
                <div style="display: flex; justify-content: center; align-items: center; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <div style="text-align: center; margin: 0 15px;">
                        <div style="font-size: 12px; color: #999; margin-bottom: 5px;">LEFT</div>
                        <div id="preview-left" style="font-size: 24px; padding: 10px; background: white; border-radius: 4px; min-width: 60px; border: 2px solid #dee2e6;">üéâ</div>
                        <div style="font-size: 10px; color: #666; margin-top: 5px;">RDY</div>
                    </div>
                    
                    <div style="text-align: center; margin: 0 15px;">
                        <div style="font-size: 12px; color: #999; margin-bottom: 5px;">MIDDLE</div>
                        <div id="preview-middle" style="font-size: 24px; padding: 10px; background: white; border-radius: 4px; min-width: 60px; border: 2px solid #dee2e6;">üò¥</div>
                        <div style="font-size: 10px; color: #666; margin-top: 5px;">SLP</div>
                    </div>
                    
                    <div style="text-align: center; margin: 0 15px;">
                        <div style="font-size: 12px; color: #999; margin-bottom: 5px;">RIGHT</div>
                        <div id="preview-right" style="font-size: 24px; padding: 10px; background: white; border-radius: 4px; min-width: 60px; border: 2px solid #dee2e6;">‚ù§Ô∏è</div>
                        <div style="font-size: 10px; color: #666; margin-top: 5px;">HR</div>
                    </div>
                </div>
                
                <!-- Row 1 Position Selectors -->
                <div id="row1-selectors" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 20px 0;">
                    <div>
                        <label style="display: block; font-weight: 500; margin-bottom: 5px;">Row 1 Left:</label>
                        <select id="row1-left" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="0" selected>üéâ Readiness</option>
                            <option value="1">üò¥ Sleep</option>
                            <option value="2">‚ù§Ô∏è Heart Rate</option>
                            <option value="3">üèÉ Activity</option>
                            <option value="4">üò§ Stress</option>
                            <option value="-1">-- None --</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; font-weight: 500; margin-bottom: 5px;">Row 1 Middle:</label>
                        <select id="row1-middle" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="0">üéâ Readiness</option>
                            <option value="1" selected>üò¥ Sleep</option>
                            <option value="2">‚ù§Ô∏è Heart Rate</option>
                            <option value="3">üèÉ Activity</option>
                            <option value="4">üò§ Stress</option>
                            <option value="-1">-- None --</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; font-weight: 500; margin-bottom: 5px;">Row 1 Right:</label>
                        <select id="row1-right" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="0">üéâ Readiness</option>
                            <option value="1">üò¥ Sleep</option>
                            <option value="2" selected>‚ù§Ô∏è Heart Rate</option>
                            <option value="3">üèÉ Activity</option>
                            <option value="4">üò§ Stress</option>
                            <option value="-1">-- None --</option>
                        </select>
                    </div>
                </div>
                
                <!-- Row 2 Position Selectors (hidden by default) -->
                <div id="row2-selectors" style="display: none; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 20px 0;">
                    <div>
                        <label style="display: block; font-weight: 500; margin-bottom: 5px;">Row 2 Left:</label>
                        <select id="row2-left" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="0">üéâ Readiness</option>
                            <option value="1">üò¥ Sleep</option>
                            <option value="2">‚ù§Ô∏è Heart Rate</option>
                            <option value="3" selected>üèÉ Activity</option>
                            <option value="4">üò§ Stress</option>
                            <option value="-1">-- None --</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; font-weight: 500; margin-bottom: 5px;">Row 2 Middle:</label>
                        <select id="row2-middle" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="0">üéâ Readiness</option>
                            <option value="1">üò¥ Sleep</option>
                            <option value="2">‚ù§Ô∏è Heart Rate</option>
                            <option value="3">üèÉ Activity</option>
                            <option value="4" selected>üò§ Stress</option>
                            <option value="-1">-- None --</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; font-weight: 500; margin-bottom: 5px;">Row 2 Right:</label>
                        <select id="row2-right" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="0">üéâ Readiness</option>
                            <option value="1">üò¥ Sleep</option>
                            <option value="2">‚ù§Ô∏è Heart Rate</option>
                            <option value="3">üèÉ Activity</option>
                            <option value="4">üò§ Stress</option>
                            <option value="-1" selected>-- None --</option>
                        </select>
                    </div>
                </div>
                
                <div class="section-box" style="margin: 20px 0;">
                    <div class="section-title">‚öôÔ∏è Display Settings</div>
                    <p style="font-size: 14px; color: #666; margin: 10px 0;">Configure how your watchface displays information.</p>
                    
                    <div style="margin: 15px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Data Refresh Frequency:</label>
                        <select id="refresh-frequency" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="15">15 minutes</option>
                            <option value="30">30 minutes</option>
                            <option value="60" selected>1 hour</option>
                            <option value="120">2 hours</option>
                            <option value="240">4 hours</option>
                        </select>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">üìÖ Date Format:</label>
                        <select id="date-format" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="0" selected>MM-DD-YYYY (US Format)</option>
                            <option value="1">DD-MM-YYYY (International Format)</option>
                        </select>
                        <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Choose how the date appears below the time on your watchface</p>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">üé® Theme Mode:</label>
                        <select id="theme-mode" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="0" selected>üåô Dark Mode (Default)</option>
                            <option value="1">‚òÄÔ∏è Light Mode</option>
                            <option value="2">üé® Custom Color</option>
                        </select>
                        <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Choose between dark mode (white text on black) or light mode (black text on white)</p>
                    </div>
                    
                    <!-- Color Picker Section -->
                    <div id="color-picker-section" style="margin: 15px 0; display: none; padding: 15px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">üé® Custom Color Selection</h4>
                        <p style="font-size: 12px; color: #666; margin: 0 0 15px 0;">Choose a background color for your watchface. Text color will automatically adjust for readability.</p>
                        
                        <!-- Live Preview -->
                        <div style="margin: 10px 0;">
                            <div id="color-preview" style="width: 100%; height: 60px; border-radius: 6px; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center; font-weight: bold; background: #000000; color: #ffffff;">
                                Preview: 12:34
                            </div>
                            <p style="font-size: 11px; color: #666; margin: 5px 0 0 0; text-align: center;">Selected: <span id="selected-color-name">Black</span></p>
                        </div>
                        
                        <!-- Color Palette Grid - Full 64 Pebble Colors -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(30px, 1fr)); gap: 4px; margin: 15px 0; max-width: 100%;">
                            <!-- Row 1: Dark Colors -->
                            <div class="color-option" onclick="selectColor('#000000', 'Black', 0)" style="background: #000000; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Black"></div>
                            <div class="color-option" onclick="selectColor('#003366', 'Oxford Blue', 1)" style="background: #003366; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Oxford Blue"></div>
                            <div class="color-option" onclick="selectColor('#003d82', 'Duke Blue', 2)" style="background: #003d82; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Duke Blue"></div>
                            <div class="color-option" onclick="selectColor('#0055aa', 'Blue', 3)" style="background: #0055aa; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Blue"></div>
                            <div class="color-option" onclick="selectColor('#004400', 'Dark Green', 4)" style="background: #004400; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Dark Green"></div>
                            <div class="color-option" onclick="selectColor('#004953', 'Midnight Green', 5)" style="background: #004953; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Midnight Green"></div>
                            <div class="color-option" onclick="selectColor('#0047ab', 'Cobalt Blue', 6)" style="background: #0047ab; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Cobalt Blue"></div>
                            <div class="color-option" onclick="selectColor('#7366bd', 'Blue Moon', 7)" style="background: #7366bd; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Blue Moon"></div>
                            
                            <!-- Row 2: Green/Blue Colors -->
                            <div class="color-option" onclick="selectColor('#009900', 'Islamic Green', 8)" style="background: #009900; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Islamic Green"></div>
                            <div class="color-option" onclick="selectColor('#55aa00', 'Jaeger Green', 9)" style="background: #55aa00; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Jaeger Green"></div>
                            <div class="color-option" onclick="selectColor('#00aaaa', 'Tiffany Blue', 10)" style="background: #00aaaa; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Tiffany Blue"></div>
                            <div class="color-option" onclick="selectColor('#00aaff', 'Vivid Cerulean', 11)" style="background: #00aaff; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Vivid Cerulean"></div>
                            <div class="color-option" onclick="selectColor('#00ff00', 'Green', 12)" style="background: #00ff00; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Green"></div>
                            <div class="color-option" onclick="selectColor('#55ff00', 'Malachite', 13)" style="background: #55ff00; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Malachite"></div>
                            <div class="color-option" onclick="selectColor('#00ff55', 'Medium Spring Green', 14)" style="background: #00ff55; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Medium Spring Green"></div>
                            <div class="color-option" onclick="selectColor('#00ffff', 'Cyan', 15)" style="background: #00ffff; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Cyan"></div>
                            
                            <!-- Row 3: Purple/Red Colors -->
                            <div class="color-option" onclick="selectColor('#aa0055', 'Bulgarian Rose', 16)" style="background: #aa0055; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Bulgarian Rose"></div>
                            <div class="color-option" onclick="selectColor('#550055', 'Imperial Purple', 17)" style="background: #550055; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Imperial Purple"></div>
                            <div class="color-option" onclick="selectColor('#5500aa', 'Indigo', 18)" style="background: #5500aa; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Indigo"></div>
                            <div class="color-option" onclick="selectColor('#0055ff', 'Electric Ultramarine', 19)" style="background: #0055ff; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Electric Ultramarine"></div>
                            <div class="color-option" onclick="selectColor('#555500', 'Army Green', 20)" style="background: #555500; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Army Green"></div>
                            <div class="color-option" onclick="selectColor('#555555', 'Dark Gray', 21)" style="background: #555555; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Dark Gray"></div>
                            <div class="color-option" onclick="selectColor('#5555aa', 'Liberty', 22)" style="background: #5555aa; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Liberty"></div>
                            <div class="color-option" onclick="selectColor('#5555ff', 'Very Light Blue', 23)" style="background: #5555ff; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Very Light Blue"></div>
                            
                            <!-- Row 4: Medium Colors -->
                            <div class="color-option" onclick="selectColor('#55aa55', 'Kelly Green', 24)" style="background: #55aa55; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Kelly Green"></div>
                            <div class="color-option" onclick="selectColor('#aaaa00', 'May Green', 25)" style="background: #aaaa00; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="May Green"></div>
                            <div class="color-option" onclick="selectColor('#55aaaa', 'Cadet Blue', 26)" style="background: #55aaaa; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Cadet Blue"></div>
                            <div class="color-option" onclick="selectColor('#55aaff', 'Picton Blue', 27)" style="background: #55aaff; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Picton Blue"></div>
                            <div class="color-option" onclick="selectColor('#55ff55', 'Bright Green', 28)" style="background: #55ff55; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Bright Green"></div>
                            <div class="color-option" onclick="selectColor('#aaff00', 'Screamin Green', 29)" style="background: #aaff00; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Screamin Green"></div>
                            <div class="color-option" onclick="selectColor('#55ffaa', 'Medium Aquamarine', 30)" style="background: #55ffaa; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Medium Aquamarine"></div>
                            <div class="color-option" onclick="selectColor('#55ffff', 'Electric Blue', 31)" style="background: #55ffff; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Electric Blue"></div>
                            
                            <!-- Row 5: Red/Purple Colors -->
                            <div class="color-option" onclick="selectColor('#aa0000', 'Dark Candy Apple Red', 32)" style="background: #aa0000; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Dark Candy Apple Red"></div>
                            <div class="color-option" onclick="selectColor('#aa0055', 'Jazzberry Jam', 33)" style="background: #aa0055; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Jazzberry Jam"></div>
                            <div class="color-option" onclick="selectColor('#aa00aa', 'Purple', 34)" style="background: #aa00aa; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Purple"></div>
                            <div class="color-option" onclick="selectColor('#aa00ff', 'Vivid Violet', 35)" style="background: #aa00ff; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Vivid Violet"></div>
                            <div class="color-option" onclick="selectColor('#aa5500', 'Windsor Tan', 36)" style="background: #aa5500; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Windsor Tan"></div>
                            <div class="color-option" onclick="selectColor('#aa5555', 'Rose Vale', 37)" style="background: #aa5555; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Rose Vale"></div>
                            <div class="color-option" onclick="selectColor('#aa55aa', 'Purpureus', 38)" style="background: #aa55aa; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Purpureus"></div>
                            <div class="color-option" onclick="selectColor('#aa55ff', 'Lavender Indigo', 39)" style="background: #aa55ff; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Lavender Indigo"></div>
                            
                            <!-- Row 6: Yellow/Green Colors -->
                            <div class="color-option" onclick="selectColor('#aaaa55', 'Limerick', 40)" style="background: #aaaa55; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Limerick"></div>
                            <div class="color-option" onclick="selectColor('#aaaa00', 'Brass', 41)" style="background: #aaaa00; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Brass"></div>
                            <div class="color-option" onclick="selectColor('#aaaaaa', 'Light Gray', 42)" style="background: #aaaaaa; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Light Gray"></div>
                            <div class="color-option" onclick="selectColor('#aaaaff', 'Baby Blue Eyes', 43)" style="background: #aaaaff; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Baby Blue Eyes"></div>
                            <div class="color-option" onclick="selectColor('#aaff55', 'Spring Bud', 44)" style="background: #aaff55; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Spring Bud"></div>
                            <div class="color-option" onclick="selectColor('#aaff00', 'Inchworm', 45)" style="background: #aaff00; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Inchworm"></div>
                            <div class="color-option" onclick="selectColor('#aaffaa', 'Mint Green', 46)" style="background: #aaffaa; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Mint Green"></div>
                            <div class="color-option" onclick="selectColor('#aaffff', 'Celeste', 47)" style="background: #aaffff; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Celeste"></div>
                            
                            <!-- Row 7: Bright Colors -->
                            <div class="color-option" onclick="selectColor('#ff0000', 'Red', 48)" style="background: #ff0000; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Red"></div>
                            <div class="color-option" onclick="selectColor('#ff0055', 'Folly', 49)" style="background: #ff0055; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Folly"></div>
                            <div class="color-option" onclick="selectColor('#ff00aa', 'Fashion Magenta', 50)" style="background: #ff00aa; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Fashion Magenta"></div>
                            <div class="color-option" onclick="selectColor('#ff00ff', 'Magenta', 51)" style="background: #ff00ff; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Magenta"></div>
                            <div class="color-option" onclick="selectColor('#ff5500', 'Orange', 52)" style="background: #ff5500; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Orange"></div>
                            <div class="color-option" onclick="selectColor('#ff5555', 'Sunset Orange', 53)" style="background: #ff5555; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Sunset Orange"></div>
                            <div class="color-option" onclick="selectColor('#ff55aa', 'Brilliant Rose', 54)" style="background: #ff55aa; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Brilliant Rose"></div>
                            <div class="color-option" onclick="selectColor('#ff55ff', 'Shocking Pink', 55)" style="background: #ff55ff; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Shocking Pink"></div>
                            
                            <!-- Row 8: Light Colors -->
                            <div class="color-option" onclick="selectColor('#ffaa00', 'Chrome Yellow', 56)" style="background: #ffaa00; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Chrome Yellow"></div>
                            <div class="color-option" onclick="selectColor('#ffaa55', 'Rajah', 57)" style="background: #ffaa55; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Rajah"></div>
                            <div class="color-option" onclick="selectColor('#ffaaaa', 'Melon', 58)" style="background: #ffaaaa; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Melon"></div>
                            <div class="color-option" onclick="selectColor('#ffaaff', 'Rich Brilliant Lavender', 59)" style="background: #ffaaff; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Rich Brilliant Lavender"></div>
                            <div class="color-option" onclick="selectColor('#ffff00', 'Yellow', 60)" style="background: #ffff00; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Yellow"></div>
                            <div class="color-option" onclick="selectColor('#ffff55', 'Icterine', 61)" style="background: #ffff55; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Icterine"></div>
                            <div class="color-option" onclick="selectColor('#ffffaa', 'Pastel Yellow', 62)" style="background: #ffffaa; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; touch-action: manipulation;" title="Pastel Yellow"></div>
                            <div class="color-option" onclick="selectColor('#ffffff', 'White', 63)" style="background: #ffffff; width: 100%; height: 30px; min-width: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #333; touch-action: manipulation;" title="White"></div>
                        </div>
                        
                        <!-- Apply Button -->
                        <div style="text-align: center; margin: 15px 0 0 0;">
                            <button onclick="applySelectedColor()" class="connect-btn" style="width: auto; padding: 8px 16px; font-size: 14px;">Apply Selected Color</button>
                        </div>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="show-debug" checked style="margin-right: 10px;">
                            <span>Show debug messages on watchface</span>
                        </label>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 15px 0;">
                    <button onclick="applyMeasurementLayout()" class="connect-btn" style="width: auto; padding: 10px 20px;">Apply Layout</button>
                </div>
                

            </div>
        </div>
        
    </div> <!-- End Container -->

    <script>
        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            var tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(function(tab) {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            var tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(function(button) {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked tab button
            event.target.classList.add('active');
        }
        
        // Toggle debug information visibility
        function toggleDebugVisibility() {
            var debugSection = document.querySelector('.debug-section');
            var showDebug = document.getElementById('show-debug').checked;
            
            if (showDebug) {
                debugSection.style.display = 'block';
            } else {
                debugSection.style.display = 'none';
            }
        }
        
        // Measurement layout customization - using numeric keys to match select values
        var measurementConfig = {
            '0': { emoji: 'üéâ', label: 'RDY', name: 'readiness' },
            '1': { emoji: 'üò¥', label: 'SLP', name: 'sleep' },
            '2': { emoji: '‚ù§Ô∏è', label: 'HR', name: 'heart_rate' }
        };
        
        // Smart duplicate prevention - automatically adjust conflicting selections
        function preventDuplicates(changedSelectId) {
            var leftSelect = document.getElementById('left-position');
            var middleSelect = document.getElementById('middle-position');
            var rightSelect = document.getElementById('right-position');
            
            var leftValue = leftSelect.value;
            var middleValue = middleSelect.value;
            var rightValue = rightSelect.value;
            
            var allValues = ['0', '1', '2']; // All possible measurement values
            
            console.log('Preventing duplicates after changing', changedSelectId, '- Values: L=' + leftValue + ' M=' + middleValue + ' R=' + rightValue);
            
            // Find duplicates and resolve them intelligently
            if (changedSelectId === 'left-position') {
                // If left conflicts with middle, move middle to available value
                if (leftValue === middleValue) {
                    var availableForMiddle = allValues.find(function(val) {
                        return val !== leftValue && val !== rightValue;
                    });
                    if (availableForMiddle) {
                        middleSelect.value = availableForMiddle;
                        console.log('Auto-moved middle from', middleValue, 'to', availableForMiddle);
                    }
                }
                // If left conflicts with right, move right to available value
                if (leftValue === rightValue) {
                    var availableForRight = allValues.find(function(val) {
                        return val !== leftValue && val !== middleSelect.value;
                    });
                    if (availableForRight) {
                        rightSelect.value = availableForRight;
                        console.log('Auto-moved right from', rightValue, 'to', availableForRight);
                    }
                }
            } else if (changedSelectId === 'middle-position') {
                // If middle conflicts with left, move left to available value
                if (middleValue === leftValue) {
                    var availableForLeft = allValues.find(function(val) {
                        return val !== middleValue && val !== rightValue;
                    });
                    if (availableForLeft) {
                        leftSelect.value = availableForLeft;
                        console.log('Auto-moved left from', leftValue, 'to', availableForLeft);
                    }
                }
                // If middle conflicts with right, move right to available value
                if (middleValue === rightValue) {
                    var availableForRight = allValues.find(function(val) {
                        return val !== middleValue && val !== leftSelect.value;
                    });
                    if (availableForRight) {
                        rightSelect.value = availableForRight;
                        console.log('Auto-moved right from', rightValue, 'to', availableForRight);
                    }
                }
            } else if (changedSelectId === 'right-position') {
                // If right conflicts with left, move left to available value
                if (rightValue === leftValue) {
                    var availableForLeft = allValues.find(function(val) {
                        return val !== rightValue && val !== middleValue;
                    });
                    if (availableForLeft) {
                        leftSelect.value = availableForLeft;
                        console.log('Auto-moved left from', leftValue, 'to', availableForLeft);
                    }
                }
                // If right conflicts with middle, move middle to available value
                if (rightValue === middleValue) {
                    var availableForMiddle = allValues.find(function(val) {
                        return val !== rightValue && val !== leftSelect.value;
                    });
                    if (availableForMiddle) {
                        middleSelect.value = availableForMiddle;
                        console.log('Auto-moved middle from', middleValue, 'to', availableForMiddle);
                    }
                }
            }
        }
        
        function updateMeasurementLayout() {
            var leftValue = document.getElementById('left-position').value;
            var middleValue = document.getElementById('middle-position').value;
            var rightValue = document.getElementById('right-position').value;
            
            console.log('Updating preview - L:', leftValue, 'M:', middleValue, 'R:', rightValue);
            
            // Update visual preview
            if (measurementConfig[leftValue]) {
                document.getElementById('preview-left').textContent = measurementConfig[leftValue].emoji;
                document.querySelector('#preview-left').nextElementSibling.textContent = measurementConfig[leftValue].label;
            }
            
            if (measurementConfig[middleValue]) {
                document.getElementById('preview-middle').textContent = measurementConfig[middleValue].emoji;
                document.querySelector('#preview-middle').nextElementSibling.textContent = measurementConfig[middleValue].label;
            }
            
            if (measurementConfig[rightValue]) {
                document.getElementById('preview-right').textContent = measurementConfig[rightValue].emoji;
                document.querySelector('#preview-right').nextElementSibling.textContent = measurementConfig[rightValue].label;
            }
            
            // Check for duplicates and enable/disable apply button accordingly
            var positions = [leftValue, middleValue, rightValue];
            var hasDuplicates = positions.length !== new Set(positions).size;
            
            // Visual feedback - always show clean state since we prevent duplicates
            var selects = ['left-position', 'middle-position', 'right-position'];
            selects.forEach(function(selectId) {
                var select = document.getElementById(selectId);
                select.style.borderColor = '#ccc';
                select.style.backgroundColor = 'white';
            });
            
            // Update apply button state
            var applyButton = document.querySelector('button[onclick="applyMeasurementLayout()"]');
            if (hasDuplicates) {
                applyButton.disabled = true;
                applyButton.textContent = 'Fix Duplicates First';
                applyButton.style.backgroundColor = '#6c757d';
            } else {
                applyButton.disabled = false;
                applyButton.textContent = 'Apply Layout';
                applyButton.style.backgroundColor = '#007bff';
            }
        }
        
        function applyMeasurementLayout() {
            // Get layout rows setting
            var layoutRows = localStorage.getItem('oura_layout_rows') || '1';
            
            // Get row 1 values
            var row1Left = document.getElementById('row1-left').value;
            var row1Middle = document.getElementById('row1-middle').value;
            var row1Right = document.getElementById('row1-right').value;
            
            // Get row 2 values (if 2-row layout)
            var row2Left = layoutRows === '2' ? document.getElementById('row2-left').value : '-1';
            var row2Middle = layoutRows === '2' ? document.getElementById('row2-middle').value : '-1';
            var row2Right = layoutRows === '2' ? document.getElementById('row2-right').value : '-1';
            
            // Store all layout settings in localStorage
            localStorage.setItem('oura_layout_rows', layoutRows);
            localStorage.setItem('oura_row1_left', row1Left);
            localStorage.setItem('oura_row1_middle', row1Middle);
            localStorage.setItem('oura_row1_right', row1Right);
            localStorage.setItem('oura_row2_left', row2Left);
            localStorage.setItem('oura_row2_middle', row2Middle);
            localStorage.setItem('oura_row2_right', row2Right);
            
            debugLog('üìä Applying flexible layout:');
            debugLog('üìä Rows: ' + layoutRows);
            debugLog('üìä Row 1: L=' + row1Left + ' M=' + row1Middle + ' R=' + row1Right);
            debugLog('üìä Row 2: L=' + row2Left + ' M=' + row2Middle + ' R=' + row2Right);
            
            // Send layout update to Pebble immediately
            var currentToken = localStorage.getItem('oura_access_token');
            debugLog('üîç Current token status: ' + (currentToken ? 'Found' : 'Not found'));
            
            if (currentToken) {
                debugLog('üîÑ Sending flexible layout update with token...');
                sendToPebble(currentToken);
            } else {
                debugLog('‚ö†Ô∏è No token found - cannot send layout update');
                debugLog('üí° Layout saved to localStorage - will apply on next data refresh');
                alert('Please connect to your Oura Ring first before applying layout changes.');
            }
            
            // Visual feedback
            var button = document.querySelector('button[onclick="applyMeasurementLayout()"]');
            var originalText = button.textContent;
            button.textContent = '‚úÖ Applied!';
            button.style.backgroundColor = '#28a745';
            
            setTimeout(function() {
                button.textContent = originalText;
                button.style.backgroundColor = '#007bff';
            }, 2000);
        }
        
        function loadSavedMeasurementLayout() {
            var saved = localStorage.getItem('oura_measurement_layout');
            if (saved) {
                try {
                    var layout = JSON.parse(saved);
                    console.log('Loading saved layout:', layout);
                    document.getElementById('left-position').value = layout.left;
                    document.getElementById('middle-position').value = layout.middle;
                    document.getElementById('right-position').value = layout.right;
                    updateMeasurementLayout();
                } catch (e) {
                    console.log('Error loading saved layout:', e);
                    // If loading fails, set defaults and update preview
                    setDefaultLayout();
                }
            } else {
                // No saved layout, set defaults
                setDefaultLayout();
            }
        }
        
        function setDefaultLayout() {
            // Default: Readiness(0) - Sleep(1) - Heart Rate(2)
            document.getElementById('left-position').value = '0';
            document.getElementById('middle-position').value = '1';
            document.getElementById('right-position').value = '2';
            updateMeasurementLayout();
            debugLog('üìä Using default measurement layout');
        }
        
        // PURE STATIC CONFIG - NO POPUPS, ONLY REDIRECTS
        var CLIENT_ID = 'TGDTXUBGWULVNKSC';
        var REDIRECT_URI = 'https://peppy-pothos-093b81.netlify.app/pebble-static-config.html';
        var AUTH_URL = 'https://cloud.ouraring.com/oauth/authorize';
        var SCOPES = 'daily heartrate'; // daily_* endpoints + /usercollection/heartrate

        // Generate OAuth URL - client-side-only flow
        function generateAuthUrl() {
            return AUTH_URL + 
                '?response_type=token' +  // CLIENT-SIDE-ONLY
                '&client_id=' + CLIENT_ID +
                '&redirect_uri=' + encodeURIComponent(REDIRECT_URI) +
                '&scope=' + encodeURIComponent(SCOPES);
        }

        // Check for token in URL fragment
        function checkForToken() {
            var hash = window.location.hash;
            if (hash && hash.includes('access_token=')) {
                var params = new URLSearchParams(hash.substring(1));
                var token = params.get('access_token');
                var expiresIn = params.get('expires_in') || 2592000;
                
                if (token) {
                    // Store token
                    localStorage.setItem('oura_access_token', token);
                    localStorage.setItem('oura_token_expires', Date.now() + (expiresIn * 1000));
                    
                    // Clean URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // Show connected state
                    showConnected(token);
                    // Do not auto-close or auto-send. Developer can review and send manually.
                    return true;
                }
            }
            return false;
        }

        // Check stored token
        function checkStoredToken() {
            var token = localStorage.getItem('oura_access_token');
            var expires = localStorage.getItem('oura_token_expires');
            
            if (token && expires && Date.now() < parseInt(expires)) {
                showConnected(token);
                return true;
            }
            return false;
        }

        // Show connected state
        function showConnected(token) {
            document.getElementById('status').className = 'status connected';
            document.getElementById('status').textContent = '‚úÖ Connected to Oura (token stored)';
            document.getElementById('connect-section').style.display = 'none';
            document.getElementById('connected-section').style.display = 'block';
            
            var display = token.substring(0, 8) + '...' + token.substring(token.length - 4);
            document.getElementById('token-display').textContent = 'Token: ' + display;
        }

        // Show disconnected state
        function showDisconnected() {
            document.getElementById('status').className = 'status disconnected';
            document.getElementById('status').textContent = '‚ùå Not connected';
            document.getElementById('connect-section').style.display = 'block';
            document.getElementById('connected-section').style.display = 'none';
        }

        // DIRECT REDIRECT - NO POPUP!
        function connect() {
            console.log('Direct redirect to Oura OAuth2...');
            window.location = generateAuthUrl();  // PURE REDIRECT
        }

        // Reconnect
        function reconnect() {
            clearSettings();
            window.location = generateAuthUrl();  // PURE REDIRECT
        }

        // Send settings to Pebble
        function sendToPebble(token) {
            try {
                // Get flexible layout configuration
                var layoutRows = localStorage.getItem('oura_layout_rows') || '1';
                var row1Left = localStorage.getItem('oura_row1_left') || '0';   // Readiness
                var row1Middle = localStorage.getItem('oura_row1_middle') || '1'; // Sleep
                var row1Right = localStorage.getItem('oura_row1_right') || '2';   // Heart Rate
                var row2Left = localStorage.getItem('oura_row2_left') || '3';   // Activity
                var row2Middle = localStorage.getItem('oura_row2_middle') || '4'; // Stress
                var row2Right = localStorage.getItem('oura_row2_right') || '-1'; // None
                
                // Get other settings
                var dateFormat = localStorage.getItem('oura_date_format') || '0';
                var themeMode = localStorage.getItem('oura_theme_mode') || '0';
                var showDebug = localStorage.getItem('oura_show_debug') === 'true';
                var refreshFrequency = localStorage.getItem('oura_refresh_frequency') || '15';
                var customColorIndex = localStorage.getItem('oura_custom_color_index') || '0';
                
                var settings = { 
                    oura_access_token: token,
                    layout_rows: parseInt(layoutRows),
                    row1_left: parseInt(row1Left),
                    row1_middle: parseInt(row1Middle),
                    row1_right: parseInt(row1Right),
                    row2_left: parseInt(row2Left),
                    row2_middle: parseInt(row2Middle),
                    row2_right: parseInt(row2Right),
                    date_format: parseInt(dateFormat),
                    theme_mode: parseInt(themeMode),
                    show_debug: showDebug,
                    refresh_frequency: parseInt(refreshFrequency),
                    custom_color_index: parseInt(customColorIndex)
                };
                var returnUrl = 'pebblejs://close#' + encodeURIComponent(JSON.stringify(settings));
                
                debugLog('üì± Sending settings to Pebble:');
                debugLog('Token: ' + token.substring(0, 10) + '...' + token.substring(token.length - 6));
                debugLog('Layout Rows: ' + layoutRows);
                debugLog('Row 1: L=' + row1Left + ' M=' + row1Middle + ' R=' + row1Right);
                debugLog('Row 2: L=' + row2Left + ' M=' + row2Middle + ' R=' + row2Right);
                debugLog('Theme Mode: ' + themeMode + ', Debug: ' + showDebug);
                debugLog('Settings: ' + JSON.stringify(settings));
                debugLog('Return URL: ' + returnUrl);
                
                // Perform the close immediately when user requests send
                window.location = returnUrl;
            } catch (error) {
                debugLog('‚ùå Error sending to Pebble: ' + error.message);
                console.log('Could not return to Pebble (expected in browser)');
            }
        }

        function resendToPebble() {
            var token = localStorage.getItem('oura_access_token');
            if (!token) { debugLog('‚ùå Resend failed: no token in storage'); return; }
            debugLog('üîÅ Manual resend to Pebble requested');
            sendToPebble(token);
        }

        function sendAndClose() {
            var token = localStorage.getItem('oura_access_token');
            if (!token) { debugLog('‚ùå Send failed: no token in storage'); return; }
            sendToPebble(token);
        }

        function closeWebview() {
            try {
                debugLog('üîí Closing webview without sending');
                window.location = 'pebblejs://close#' + encodeURIComponent(JSON.stringify({}));
            } catch (e) {
                debugLog('‚ùå Close failed (likely in normal browser): ' + e.message);
            }
        }

        function clearSettings() {
            localStorage.removeItem('oura_access_token');
            localStorage.removeItem('oura_token_expires');
            document.getElementById('debug-log').textContent = 'Debug information will appear here...';
            showDisconnected();
            updateDevPanel();
            renderTokenDetails();
            clearApiResults();
            debugLog('üßπ Cleared stored settings');
        }

        // Debug logging function with HTML sanitization
        function debugLog(message) {
            var timestamp = new Date().toLocaleTimeString();
            var logElement = document.getElementById('debug-log');
            if (!logElement) return;
            
            // Sanitize message to prevent HTML injection
            var sanitized = String(message || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            // Truncate very long messages that might contain full HTML pages
            if (sanitized.length > 500) {
                sanitized = sanitized.substring(0, 500) + '... [truncated]';
            }
            
            logElement.textContent += '[' + timestamp + '] ' + sanitized + '\n';
            logElement.scrollTop = logElement.scrollHeight;
        }

        function copyLog() {
            var logElement = document.getElementById('debug-log');
            var statusEl = document.getElementById('copy-status');
            if (!logElement) return;
            var text = logElement.innerText || logElement.textContent || '';
            if (!text) {
                if (statusEl) { statusEl.style.display = 'block'; statusEl.textContent = 'Log is empty'; }
                setTimeout(function(){ if (statusEl) statusEl.style.display = 'none'; }, 1500);
                return;
            }
            var onSuccess = function(){
                if (statusEl) { statusEl.style.display = 'block'; statusEl.textContent = 'Copied!'; }
                debugLog(' Log copied to clipboard');
                setTimeout(function(){ if (statusEl) statusEl.style.display = 'none'; }, 1200);
            };
            var onFail = function(err){
                if (statusEl) { statusEl.style.display = 'block'; statusEl.textContent = 'Copy failed'; }
                debugLog(' Copy failed: ' + (err && err.message ? err.message : 'unknown error'));
                setTimeout(function(){ if (statusEl) statusEl.style.display = 'none'; }, 1500);
            };
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(onSuccess).catch(onFail);
            } else {
                // Fallback
                try {
                    var ta = document.createElement('textarea');
                    ta.value = text;
                    ta.setAttribute('readonly', '');
                    ta.style.position = 'absolute';
                    ta.style.left = '-9999px';
                    document.body.appendChild(ta);
                    ta.select();
                    var ok = document.execCommand('copy');
                    document.body.removeChild(ta);
                    if (ok) onSuccess(); else onFail();
                } catch (e) { onFail(e); }
            }
        }

        // Test Oura API with current token
        function testOuraAPI() {
            var token = localStorage.getItem('oura_access_token');
            
            if (!token) {
                debugLog('‚ùå No token found in localStorage');
                appendApiResult('Direct API Test', 'No Token', 'Please authenticate first.');
                return;
            }
            
            var useProxy = getUseProxySetting() || isPebbleWebView();
            var today = new Date().toISOString().split('T')[0];
            if (useProxy) {
                debugLog('üß™ Testing Oura API via Proxy');
                var pu = 'https://peppy-pothos-093b81.netlify.app/.netlify/functions/oura-proxy?endpoint=heartrate&token=' + encodeURIComponent(token) + '&start_date=' + today + '&end_date=' + today;
                var px = new XMLHttpRequest();
                px.open('GET', pu, true);
                var start = Date.now();
                px.onreadystatechange = function(){
                    if (px.readyState === 4) {
                        var ms = Date.now() - start;
                        debugLog('üì° Proxy Test ‚Üí status ' + px.status + ' in ' + ms + 'ms');
                        appendApiResult('Proxy API Test (heartrate)', px.status, (px.responseText || '').substring(0, 200) + '...');
                        if (px.status === 200) {
                            try { var data = JSON.parse(px.responseText); debugLog('‚úÖ Proxy OK - Data count: ' + (data.data ? data.data.length : 0)); } catch(e){ debugLog('‚ùå Proxy JSON Parse Error: ' + e.message); }
                        } else if (px.status === 401) {
                            debugLog('‚ö†Ô∏è Proxy 401: token expired or missing required scope');
                        }
                    }
                };
                px.send();
                return;
            }

            debugLog('üß™ Testing Oura API directly (browser request)');
            var xhr = new XMLHttpRequest();
            var url = 'https://api.ouraring.com/v2/usercollection/heartrate?start_date=' + today + '&end_date=' + today;
            xhr.open('GET', url, true);
            xhr.setRequestHeader('Authorization', 'Bearer ' + token);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    debugLog('üìä Heart Rate API Response:');
                    debugLog('Status: ' + xhr.status);
                    debugLog('Response (first 200): ' + (xhr.responseText || '').substring(0, 200) + '...');
                    appendApiResult('Direct API Test (heartrate)', xhr.status, (xhr.responseText || '').substring(0, 200) + '...');
                    if (xhr.status === 0) {
                        debugLog('‚ÑπÔ∏è Status 0 usually indicates the Pebble webview blocked the request (CORS/TLS). Use the Proxy toggle.');
                    }
                    if (xhr.status === 200) {
                        try { var data2 = JSON.parse(xhr.responseText); debugLog('‚úÖ API Success - Data count: ' + (data2.data ? data2.data.length : 0)); } catch (e) { debugLog('‚ùå JSON Parse Error: ' + e.message); }
                    } else {
                        debugLog('‚ùå API Error: ' + xhr.status + ' - ' + xhr.statusText);
                    }
                }
            };
            xhr.send();
        }

        function maskToken(t) {
            if (!t) return '(none)';
            if (t.length <= 14) return t;
            return t.substring(0, 8) + '...' + t.substring(t.length - 6);
        }

        function renderTokenDetails() {
            var token = localStorage.getItem('oura_access_token');
            var expires = localStorage.getItem('oura_token_expires');
            var el = document.getElementById('token-details');
            if (!el) return;
            if (!token) {
                el.innerHTML = '<div class="warn">No token in storage.</div>';
                return;
            }
            var expText = '(n/a)';
            if (expires) {
                var expMs = parseInt(expires, 10);
                var delta = expMs - Date.now();
                var mins = Math.max(0, Math.floor(delta / 60000));
                expText = new Date(expMs).toLocaleString() + '  (' + mins + ' min left)';
            }
            el.innerHTML = '' +
                '<div><strong>Masked Token:</strong> ' + maskToken(token) + '</div>' +
                '<div><strong>Scopes:</strong> ' + SCOPES + '</div>' +
                '<div><strong>Expires:</strong> ' + expText + '</div>';
        }

        function clearApiResults() {
            var r = document.getElementById('api-test-results');
            if (r) r.innerHTML = '';
        }

        function appendApiResult(title, status, bodySnippet) {
            var r = document.getElementById('api-test-results');
            if (!r) return;
            
            // Enhanced sanitization and truncation
            var body = String(bodySnippet || '');
            // If it looks like HTML (starts with DOCTYPE or <html), truncate heavily
            if (/^\s*<!DOCTYPE|^\s*<html/i.test(body)) {
                body = '[HTML Response - likely error page] ' + body.substring(0, 100) + '...';
            } else if (body.length > 300) {
                body = body.substring(0, 300) + '... [truncated]';
            }
            var safeBody = body.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            var row = '<div style="margin:6px 0;">' +
                      '<div><strong>' + title + ':</strong> status ' + status + '</div>' +
                      (safeBody ? '<pre style="white-space:pre-wrap;word-break:break-word;background:#f8f9fa;border:1px solid #e9ecef;padding:8px;border-radius:4px;margin:6px 0 0 0;">' + safeBody + '</pre>' : '') +
                      '</div>';
            r.innerHTML = r.innerHTML + row;
        }

        function isPebbleWebView() {
            var ua = (navigator.userAgent || '').toLowerCase();
            return /pebble|rebble/.test(ua);
        }

        function getUseProxySetting() {
            var el = document.getElementById('use-proxy-toggle');
            if (!el) return false;
            return !!el.checked;
        }

        function setUseProxyDefault() {
            var el = document.getElementById('use-proxy-toggle');
            if (!el) return;
            // Default ON in Pebble webview; OFF in normal desktop browser
            var def = isPebbleWebView();
            el.checked = def;
            el.addEventListener('change', function(){
                // no-op for now; could persist if desired
            });
        }

        function updateDevPanel() {
            var kv = document.getElementById('dev-kv');
            if (!kv) return;
            var token = localStorage.getItem('oura_access_token');
            var expires = localStorage.getItem('oura_token_expires');
            var ua = navigator.userAgent || '';
            var inPebble = /pebble|watch|mobile safari/i.test(ua);
            var expText = '(n/a)';
            if (expires) {
                var expMs = parseInt(expires, 10);
                var delta = expMs - Date.now();
                var mins = Math.max(0, Math.floor(delta / 60000));
                expText = new Date(expMs).toLocaleString() + '  (' + mins + ' min left)';
            }
            kv.innerHTML = '' +
                '<div>Env</div><div>' + (inPebble ? '<span class="ok">Pebble WebView</span>' : ua) + '</div>' +
                '<div>Scopes</div><div>' + SCOPES + '</div>' +
                '<div>Token</div><div>' + maskToken(token) + '</div>' +
                '<div>Expires</div><div>' + expText + '</div>' +
                '<div>Redirect URI</div><div>' + REDIRECT_URI + '</div>' +
                '<div>Auth URL</div><div>' + AUTH_URL + '</div>';
        }

        function autoProxySmokeTest() {
            var token = localStorage.getItem('oura_access_token');
            if (!token) return;
            var today = new Date().toISOString().split('T')[0];
            var u = 'https://peppy-pothos-093b81.netlify.app/.netlify/functions/oura-proxy?endpoint=heartrate&token=' + encodeURIComponent(token) + '&start_date=' + today + '&end_date=' + today;
            var xhr = new XMLHttpRequest();
            var started = Date.now();
            xhr.open('GET', u, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    var ms = Date.now() - started;
                    debugLog('üõ∞Ô∏è Proxy smoke test ‚Üí status ' + xhr.status + ' in ' + ms + 'ms');
                    appendApiResult('Proxy Smoke Test', xhr.status, (xhr.responseText || '').substring(0, 200) + '...');
                    if (xhr.status !== 200) {
                        debugLog('‚Ü™Ô∏é Body (first 200): ' + (xhr.responseText || '').substring(0, 200) + '...');
                        if (xhr.status === 401) {
                            debugLog('‚ö†Ô∏è Token likely missing required scope ("heartrate") or expired');
                        }
                    }
                }
            };
            xhr.send();
        }

        // Check all stored data
        function checkStoredData() {
            debugLog('üîç Checking localStorage data:');
            
            var keys = ['oura_access_token', 'oura_token_expires', 'oura_config_settings', 'oura_last_update'];
            
            keys.forEach(function(key) {
                var value = localStorage.getItem(key);
                if (value) {
                    if (key === 'oura_access_token') {
                        debugLog(key + ': ' + value.substring(0, 10) + '...' + value.substring(value.length - 6));
                    } else if (key === 'oura_token_expires') {
                        var expires = new Date(parseInt(value));
                        var now = new Date();
                        var isExpired = now > expires;
                        debugLog(key + ': ' + expires.toLocaleString() + ' (Expired: ' + isExpired + ')');
                    } else {
                        debugLog(key + ': ' + value);
                    }
                } else {
                    debugLog(key + ': (not set)');
                }
            });
            
            // Check token validity
            var token = localStorage.getItem('oura_access_token');
            var expires = localStorage.getItem('oura_token_expires');
            
            if (token && expires) {
                var isValid = Date.now() < parseInt(expires);
                debugLog('üîê Token Status: ' + (isValid ? 'VALID' : 'EXPIRED'));
            }
        }

        // Clear debug log
        function clearDebugLog() {
            document.getElementById('debug-log').textContent = 'Debug information will appear here...';
        }

        // Initialize debug section as hidden by default
        function initializeDebugVisibility() {
            var debugSection = document.querySelector('.debug-section');
            var showDebug = document.getElementById('show-debug').checked;
            
            // Hide debug section by default
            if (debugSection) {
                debugSection.style.display = showDebug ? 'block' : 'none';
            }
        }
        
        // Update construction banner with current date
        function updateConstructionDate() {
            var constructionDateElement = document.getElementById('construction-date');
            if (constructionDateElement) {
                var now = new Date();
                var dateString = now.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                constructionDateElement.textContent = dateString + ' - Some features may experience issues, delays, or unexpected behavior';
            }
        }
        
        // Load saved date format setting
        function loadSavedDateFormat() {
            var savedDateFormat = localStorage.getItem('oura_date_format');
            if (savedDateFormat !== null) {
                var dateFormatSelect = document.getElementById('date-format');
                if (dateFormatSelect) {
                    dateFormatSelect.value = savedDateFormat;
                }
            }
        }
        
        // Save date format setting
        function saveDateFormat() {
            var dateFormatSelect = document.getElementById('date-format');
            if (dateFormatSelect) {
                localStorage.setItem('oura_date_format', dateFormatSelect.value);
                debugLog('üìÖ Date format saved: ' + (dateFormatSelect.value === '0' ? 'MM-DD-YYYY' : 'DD-MM-YYYY'));
            }
        }
        
        // Load saved theme mode setting
        function loadSavedThemeMode() {
            var savedThemeMode = localStorage.getItem('oura_theme_mode');
            if (savedThemeMode !== null) {
                var themeModeSelect = document.getElementById('theme-mode');
                if (themeModeSelect) {
                    themeModeSelect.value = savedThemeMode;
                }
            }
        }
        
        // Save theme mode setting
        function saveThemeMode() {
            var themeModeSelect = document.getElementById('theme-mode');
            if (themeModeSelect) {
                localStorage.setItem('oura_theme_mode', themeModeSelect.value);
                debugLog('üé® Theme mode saved: ' + (themeModeSelect.value === '0' ? 'üåô Dark Mode' : '‚òÄÔ∏è Light Mode'));
            }
        }
        
        // Initialize - PURE STATIC, NO DYNAMIC LOADING
        document.addEventListener('DOMContentLoaded', function() {
            // Update construction banner with current date
            updateConstructionDate();
            
            // Initialize debug visibility
            initializeDebugVisibility();
            
            // Initialize measurement layout
            loadSavedMeasurementLayout();
            
            // Load saved date format
            loadSavedDateFormat();
            
            // Load saved theme mode
            loadSavedThemeMode();
            
            // Add date format change listener
            var dateFormatSelect = document.getElementById('date-format');
            if (dateFormatSelect) {
                dateFormatSelect.addEventListener('change', saveDateFormat);
            }
            
            // Add theme mode change listener
            var themeModeSelect = document.getElementById('theme-mode');
            if (themeModeSelect) {
                themeModeSelect.addEventListener('change', saveThemeMode);
            }
            
            // Add smart duplicate prevention event listeners
            document.getElementById('left-position').addEventListener('change', function() {
                preventDuplicates('left-position');
                updateMeasurementLayout();
            });
            document.getElementById('middle-position').addEventListener('change', function() {
                preventDuplicates('middle-position');
                updateMeasurementLayout();
            });
            document.getElementById('right-position').addEventListener('change', function() {
                preventDuplicates('right-position');
                updateMeasurementLayout();
            });
            
            debugLog('üöÄ Config page loaded');
            debugLog('Current URL: ' + window.location.href);
            debugLog('Requested OAuth scopes: ' + SCOPES);
            updateDevPanel();
            renderTokenDetails();
            clearApiResults();
            setUseProxyDefault();
            
            // Check for OAuth redirect
            debugLog('üîç Checking for OAuth redirect token...');
            if (checkForToken()) {
                debugLog('‚úÖ Token found in URL redirect');
                updateDevPanel();
                renderTokenDetails();
                autoProxySmokeTest();
                return;
            }
            
            // Check for stored token
            debugLog('üîç Checking for stored token...');
            if (checkStoredToken()) {
                debugLog('‚úÖ Valid stored token found');
                updateDevPanel();
                renderTokenDetails();
                autoProxySmokeTest();
                return;
            }
            
            // Show connect section
            debugLog('‚ùå No valid token found - showing connect section');
            showDisconnected();
            
            // Set up connect button - DIRECT REDIRECT ONLY
            document.getElementById('connect-btn').onclick = connect;
            
            // Log initial state
            debugLog('üìã Initial localStorage check:');
            checkStoredData();
            updateDevPanel();
            renderTokenDetails();
            clearApiResults();
            
            // Initialize color picker and theme mode
            initializeColorPicker();
            loadSavedThemeMode();
            
            // Ensure color picker and row selectors are properly initialized
            setTimeout(function() {
                updateColorPickerVisibility();
                updateRowSelectorsVisibility();
                console.log('üîß Post-initialization visibility updates complete');
            }, 100);
        });
        
        // Color Picker Functions
        var selectedColorHex = '#000000';
        var selectedColorName = 'Black';
        var selectedColorIndex = 0;
        
        function initializeColorPicker() {
            console.log('üé® Initializing color picker...');
            
            // Add theme mode change listener
            var themeModeSelect = document.getElementById('theme-mode');
            if (themeModeSelect) {
                themeModeSelect.addEventListener('change', function() {
                    console.log('üé® Theme mode changed to:', this.value);
                    saveThemeMode();
                    updateColorPickerVisibility();
                });
            }
            
            // Add layout rows change listener
            var layoutRowsSelect = document.getElementById('layout-rows');
            if (layoutRowsSelect) {
                layoutRowsSelect.addEventListener('change', function() {
                    console.log('üìä Layout rows changed to:', this.value);
                    saveLayoutRows();
                    updateRowSelectorsVisibility();
                });
                // Load saved value
                var savedRows = localStorage.getItem('oura_layout_rows') || '1';
                layoutRowsSelect.value = savedRows;
                console.log('üìä Loaded saved rows:', savedRows);
                
                // Show row 2 selectors if 2-row layout is selected
                updateRowSelectorsVisibility();
            }
            
            // Load saved position values
            loadSavedPositions();
        }
        
        // Load saved position values into dropdowns
        function loadSavedPositions() {
            // Load row 1 positions
            var row1Left = localStorage.getItem('oura_row1_left') || '0';
            var row1Middle = localStorage.getItem('oura_row1_middle') || '1';
            var row1Right = localStorage.getItem('oura_row1_right') || '2';
            
            var row1LeftSelect = document.getElementById('row1-left');
            var row1MiddleSelect = document.getElementById('row1-middle');
            var row1RightSelect = document.getElementById('row1-right');
            
            if (row1LeftSelect) row1LeftSelect.value = row1Left;
            if (row1MiddleSelect) row1MiddleSelect.value = row1Middle;
            if (row1RightSelect) row1RightSelect.value = row1Right;
            
            // Load row 2 positions
            var row2Left = localStorage.getItem('oura_row2_left') || '3';
            var row2Middle = localStorage.getItem('oura_row2_middle') || '4';
            var row2Right = localStorage.getItem('oura_row2_right') || '-1';
            
            var row2LeftSelect = document.getElementById('row2-left');
            var row2MiddleSelect = document.getElementById('row2-middle');
            var row2RightSelect = document.getElementById('row2-right');
            
            if (row2LeftSelect) row2LeftSelect.value = row2Left;
            if (row2MiddleSelect) row2MiddleSelect.value = row2Middle;
            if (row2RightSelect) row2RightSelect.value = row2Right;
            
            console.log('üìä Loaded saved positions:');
            console.log('üìä Row 1: L=' + row1Left + ' M=' + row1Middle + ' R=' + row1Right);
            console.log('üìä Row 2: L=' + row2Left + ' M=' + row2Middle + ' R=' + row2Right);
        }
        
        // Save layout rows setting
        function saveLayoutRows() {
            var layoutRowsSelect = document.getElementById('layout-rows');
            if (layoutRowsSelect) {
                localStorage.setItem('oura_layout_rows', layoutRowsSelect.value);
                var rowText = layoutRowsSelect.value === '1' ? '1 Row (larger emojis)' : '2 Rows (smaller emojis)';
                debugLog('üìê Layout rows saved: ' + rowText);
                
                // Show/hide row 2 selectors based on selection
                var row2Selectors = document.getElementById('row2-selectors');
                if (row2Selectors) {
                    if (layoutRowsSelect.value === '2') {
                        row2Selectors.style.display = 'grid';
                        console.log('‚úÖ Row 2 selectors shown');
                    } else {
                        row2Selectors.style.display = 'none';
                        console.log('‚úÖ Row 2 selectors hidden');
                    }
                }
            }
        }
        
        // Load saved theme mode setting
        function loadSavedThemeMode() {
            var savedThemeMode = localStorage.getItem('oura_theme_mode');
            var themeModeSelect = document.getElementById('theme-mode');
            console.log('üé® Loading theme mode, saved value:', savedThemeMode);
            
            if (themeModeSelect) {
                // Default to dark mode (0) if no saved value
                themeModeSelect.value = savedThemeMode !== null ? savedThemeMode : '0';
                console.log('üé® Theme mode dropdown set to:', themeModeSelect.value);
                
                // Initialize color picker if custom color mode is selected
                if (themeModeSelect.value === '2') {
                    console.log('üåà Custom color mode detected, showing picker...');
                    setTimeout(function() {
                        showColorPicker();
                    }, 200);
                } else {
                    console.log('üåà Not custom color mode, hiding picker');
                    hideColorPicker();
                }
            }
        }
        
        // Show color picker
        function showColorPicker() {
            var colorSection = document.getElementById('color-picker-section');
            if (colorSection) {
                colorSection.style.display = 'block';
                console.log('‚úÖ Color picker section is now visible');
            } else {
                console.log('‚ùå Color picker section not found');
            }
        }
        
        // Hide color picker
        function hideColorPicker() {
            var colorSection = document.getElementById('color-picker-section');
            if (colorSection) {
                colorSection.style.display = 'none';
                console.log('‚úÖ Color picker section is now hidden');
            }
        }
        
        // Save theme mode setting
        function saveThemeMode() {
            var themeMode = document.getElementById('theme-mode').value;
            localStorage.setItem('oura_theme_mode', themeMode);
            console.log('üíæ Saved theme mode:', themeMode);
            
            // Update color picker visibility
            updateColorPickerVisibility();
            
            // Send to Pebble immediately
            sendDataToWatch();
        }
        
        function updateColorPickerVisibility() {
            var themeMode = document.getElementById('theme-mode').value;
            var colorPickerSection = document.getElementById('color-picker-section');
            
            console.log('üé® Updating color picker visibility for theme mode:', themeMode);
            
            if (colorPickerSection) {
                if (themeMode === '2') { // Custom Color
                    colorPickerSection.style.display = 'block';
                    console.log('üé® Color picker shown');
                    console.log('üåà Showing color picker for custom color mode');
                    showColorPicker();
                } else {
                    colorPickerSection.style.display = 'none';
                    console.log('üé® Color picker hidden');
                    console.log('üåà Hiding color picker for standard mode');
                    hideColorPicker();
                }
            } else {
                console.error('‚ùå Color picker section not found!');
            }
        }
        
        function updateRowSelectorsVisibility() {
            var layoutRows = document.getElementById('layout-rows').value;
            var row2Selectors = document.getElementById('row2-selectors');
            
            console.log('üìä Updating row selectors visibility for rows:', layoutRows);
            
            if (row2Selectors) {
                if (layoutRows === '2') {
                    row2Selectors.style.display = 'grid';
                    console.log('üìä Row 2 selectors shown');
                } else {
                    row2Selectors.style.display = 'none';
                    console.log('üìä Row 2 selectors hidden');
                }
            } else {
                console.error('‚ùå Row 2 selectors not found!');
            }
        }
        
        function testColorPicker() {
            console.log('üß™ Manual color picker test triggered');
            var colorSection = document.getElementById('color-picker-section');
            if (colorSection) {
                colorSection.style.display = 'block';
                console.log('‚úÖ Color picker section is now visible');
            } else {
                console.log('‚ùå Color picker section not found');
            }
        }
        
        function selectColor(hex, name, colorIndex) {
            selectedColorHex = hex;
            selectedColorName = name;
            selectedColorIndex = colorIndex;
            
            // Update preview
            var preview = document.getElementById('color-preview');
            var colorName = document.getElementById('selected-color-name');
            
            if (preview) {
                preview.style.background = hex;
                // Automatic contrast detection based on luminance
                var textColor = getContrastColor(hex);
                preview.style.color = textColor;
            }
            
            if (colorName) {
                colorName.textContent = name;
            }
            
            console.log('üé® Color selected:', name, hex, 'Index:', selectedColorIndex);
        }
        
        // Calculate optimal text color for contrast based on background luminance
        function getContrastColor(hexColor) {
            // Convert hex to RGB
            var r = parseInt(hexColor.substr(1, 2), 16);
            var g = parseInt(hexColor.substr(3, 2), 16);
            var b = parseInt(hexColor.substr(5, 2), 16);
            
            // Calculate luminance using standard formula
            var luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            
            // Return white text for dark backgrounds, black text for light backgrounds
            return luminance > 0.5 ? '#000000' : '#ffffff';
        }
        
        function applySelectedColor() {
            // Store the selected color
            localStorage.setItem('oura_custom_color_index', selectedColorIndex.toString());
            localStorage.setItem('oura_custom_color_hex', selectedColorHex);
            localStorage.setItem('oura_custom_color_name', selectedColorName);
            
            console.log('üé® Applying color:', selectedColorName, selectedColorHex, 'Index:', selectedColorIndex);
            debugLog('üé® Custom color applied: ' + selectedColorName + ' (' + selectedColorHex + ')');
            
            // Send to watchface immediately
            var token = localStorage.getItem('oura_access_token');
            if (token) {
                sendToPebble(token);
            } else {
                debugLog('‚ö†Ô∏è No token found - color will be applied when watchface is configured');
            }
        }
    </script>
</body>
</html>
